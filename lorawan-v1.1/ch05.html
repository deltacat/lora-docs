<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第5章 MAC 指令 | LoRa 中文资料汇编</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="LoRa 中文资料汇编。包含 LoRaWAN 1.1 Spec 中文版（翻译）等。持续更新。">
    <link rel="preload" href="/assets/css/0.styles.f1e15b89.css" as="style"><link rel="preload" href="/assets/js/app.741f693f.js" as="script"><link rel="preload" href="/assets/js/2.1bc0aca8.js" as="script"><link rel="preload" href="/assets/js/25.7d1c55c4.js" as="script"><link rel="prefetch" href="/assets/js/10.23e15bef.js"><link rel="prefetch" href="/assets/js/11.a713a811.js"><link rel="prefetch" href="/assets/js/12.2c5eaff8.js"><link rel="prefetch" href="/assets/js/13.3bb3f94d.js"><link rel="prefetch" href="/assets/js/14.e1b9814b.js"><link rel="prefetch" href="/assets/js/15.fe1b5100.js"><link rel="prefetch" href="/assets/js/16.d147badc.js"><link rel="prefetch" href="/assets/js/17.b6bf6b8e.js"><link rel="prefetch" href="/assets/js/18.106ab12b.js"><link rel="prefetch" href="/assets/js/19.9dc7d0a2.js"><link rel="prefetch" href="/assets/js/20.e7085fe8.js"><link rel="prefetch" href="/assets/js/21.82911863.js"><link rel="prefetch" href="/assets/js/22.f46bb411.js"><link rel="prefetch" href="/assets/js/23.f1dc8101.js"><link rel="prefetch" href="/assets/js/24.b81b8f52.js"><link rel="prefetch" href="/assets/js/26.f0bc4c51.js"><link rel="prefetch" href="/assets/js/27.ec545f01.js"><link rel="prefetch" href="/assets/js/28.fc678aa5.js"><link rel="prefetch" href="/assets/js/29.d3d2abd9.js"><link rel="prefetch" href="/assets/js/3.b10d7aa1.js"><link rel="prefetch" href="/assets/js/30.cb8ae1c3.js"><link rel="prefetch" href="/assets/js/31.bae2fa66.js"><link rel="prefetch" href="/assets/js/32.a34e5210.js"><link rel="prefetch" href="/assets/js/33.6c61b41f.js"><link rel="prefetch" href="/assets/js/34.22d3b341.js"><link rel="prefetch" href="/assets/js/35.5937a0a7.js"><link rel="prefetch" href="/assets/js/36.5bcbb7cf.js"><link rel="prefetch" href="/assets/js/37.62d46c8e.js"><link rel="prefetch" href="/assets/js/38.a598cd4c.js"><link rel="prefetch" href="/assets/js/4.ad227c3b.js"><link rel="prefetch" href="/assets/js/5.b8c308d4.js"><link rel="prefetch" href="/assets/js/6.962b3fa9.js"><link rel="prefetch" href="/assets/js/7.45f46359.js"><link rel="prefetch" href="/assets/js/8.5b174735.js"><link rel="prefetch" href="/assets/js/9.2c49762f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f1e15b89.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">LoRa 中文资料汇编</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/deltacat/lora-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/deltacat/lora-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/" class="sidebar-heading clickable router-link-active"><span>LoRaWAN 1.1 规范</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch01.html" class="sidebar-link">第1章 介绍</a></li><li><a href="/lorawan-v1.1/ch02.html" class="sidebar-link">第2章 LoRaWAN 选型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/CLASS-A" class="sidebar-heading clickable open"><span>CLASS A</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch03.html" class="sidebar-link">第3章 物理消息格式</a></li><li><a href="/lorawan-v1.1/ch04.html" class="sidebar-link">第4章 MAC 帧格式</a></li><li><a href="/lorawan-v1.1/ch05.html" aria-current="page" class="active sidebar-link">第5章 MAC 指令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-1-复位指示" class="sidebar-link">5.1 复位指示</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-2-链路检查" class="sidebar-link">5.2 链路检查</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-3-数据速率适应" class="sidebar-link">5.3 数据速率适应</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-4-终端发射占空比" class="sidebar-link">5.4 终端发射占空比</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-5-接收窗口参数" class="sidebar-link">5.5 接收窗口参数</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-6-终端状态" class="sidebar-link">5.6 终端状态</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-7-信道的创建和修改" class="sidebar-link">5.7 信道的创建和修改</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-8-tx-和-rx-之间的延时设置" class="sidebar-link">5.8 TX 和 RX 之间的延时设置</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-9-终端发射参数" class="sidebar-link">5.9 终端发射参数</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-10-秘钥更新指示" class="sidebar-link">5.10 秘钥更新指示</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-11-adr-参数" class="sidebar-link">5.11 ADR 参数</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-12-设备时间" class="sidebar-link">5.12 设备时间</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-13-强制重连" class="sidebar-link">5.13 强制重连</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch05.html#_5-14-重连参数设置" class="sidebar-link">5.14 重连参数设置</a></li></ul></li><li><a href="/lorawan-v1.1/ch06.html" class="sidebar-link">第6章 终端激活</a></li><li><a href="/lorawan-v1.1/ch07.html" class="sidebar-link">第7章 重传避让</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/CLASS-B" class="sidebar-heading clickable"><span>CLASS B</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch08.html" class="sidebar-link">第8章 Class B 介绍</a></li><li><a href="/lorawan-v1.1/ch09.html" class="sidebar-link">第9章 下行同步网络的原理</a></li><li><a href="/lorawan-v1.1/ch10.html" class="sidebar-link">第10章 Class B 模式的上行帧</a></li><li><a href="/lorawan-v1.1/ch11.html" class="sidebar-link">第11章 下行 Ping 帧格式（Class B选项）</a></li><li><a href="/lorawan-v1.1/ch12.html" class="sidebar-link">第12章 信标的获得和追踪</a></li><li><a href="/lorawan-v1.1/ch13.html" class="sidebar-link">第13章 Class B下行时隙时序</a></li><li><a href="/lorawan-v1.1/ch14.html" class="sidebar-link">第14章 Class B Mac命令</a></li><li><a href="/lorawan-v1.1/ch15.html" class="sidebar-link">第15章 信标（Class B选项)</a></li><li><a href="/lorawan-v1.1/ch16.html" class="sidebar-link">第16章 Class B 单播/多播下行信道频率</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/CLASS-C" class="sidebar-heading clickable"><span>CLASS C</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch17.html" class="sidebar-link">第17章 持续接收的终端</a></li><li><a href="/lorawan-v1.1/ch18.html" class="sidebar-link">第18章 Class C MAC 指令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/SUPPORT" class="sidebar-heading clickable"><span>SUPPORT INFORMATION</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch19.html" class="sidebar-link">19 Examples and Application Information</a></li><li><a href="/lorawan-v1.1/ch20.html" class="sidebar-link">20 Recommendation on contract to be provided to the Network Server by the end-device provider at the time of provisioning</a></li><li><a href="/lorawan-v1.1/ch21.html" class="sidebar-link">21 Recommendation on finding the locally used channels</a></li><li><a href="/lorawan-v1.1/ch22.html" class="sidebar-link">22 Revisions</a></li><li><a href="/lorawan-v1.1/ch23.html" class="sidebar-link">23 术语表</a></li><li><a href="/lorawan-v1.1/ch24.html" class="sidebar-link">24 Bibliography</a></li><li><a href="/lorawan-v1.1/ch25.html" class="sidebar-link">25 NOTICE OF USE AND DISCLOSURE</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/lorawan-v1.1/appendix" class="sidebar-heading clickable"><span>附录</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第5章-mac-指令"><a href="#第5章-mac-指令" class="header-anchor">#</a> 第5章 MAC 指令</h1> <p>对网络管理者而言，有一套专门的 MAC 指令用来在网络服务器和终端 MAC 层之间交互。MAC 层指令对应用程序或者应用服务器或者运行在终端设备上的应用程序是不可见的。</p> <p>单个数据帧中可以包含任意 MAC 指令序列，要么在 <strong>FOpts</strong> 字段中捎带，要么作为独立帧将 <strong>FPort</strong> 设成 0 后放在 <strong>FRMPayload</strong> 里。FOpts 捎带的 MAC 指令总是要经过加密后发送并且长度不能超过 15 字节。通过 <strong>FRMPayload</strong> 发送的 MAC 指令也总是要经过加密，并且不能（MUST NOT）超过 <strong>FRMPayload</strong> 的最大长度。</p> <p>MAC 命令是由 1 字节命令码（command identifier，CID）跟着一段可能为空的特定命令字节序列组成的。</p> <p>MAC 指令由接收端按与传输命令相同的顺序应答或确认。每个 MAC 指令的回应依次添加到缓冲区中。所有在单个帧中接收到的 MAC 指令也必须在单个帧中回应，这意味着包含回应的缓冲区必须在一帧中发送。如果 MAC 指令回应缓冲区长度大于最大 FOpt 字段，设备必须（MUST）将缓冲区作为FRMPayload 发送到端口 0。</p> <p>如果设备同时具有应用程序负载和 MAC 应答，且两者不能都放入帧中，则应（SHALL）优先发送 MAC 应答。如果缓冲区长度大于可用的最大 FRMPayload 大小，则设备应（SHALL）在组装帧之前将缓冲区裁剪至最大 FRMPayload 的大小。</p> <p>因此，最后一个 MAC 指令的回应可能会被截断。在所有情况下，都会执行 MAC 指令的完整列表，即使必须裁剪包含 MAC 应答的缓冲区。</p> <p>网络服务器不得（MUST NOT）生成可能无法在单一上行通讯中得到终端设备应答的 MAC 指令序列。</p> <p>网络服务器应（SHALL）基于下表计算可用于响应 MAC 指令的最大 FRMPayload 大小:</p> <table class="lora-table"><tr><td rowspan="2"><b>CID</b></td> <td rowspan="2"><b>Command</b></td> <td colspan="2"><b>由谁<br>发送</b></td> <td rowspan="2"><b>简短描述</b></td></tr> <tr><td>终端</td> <td>网关</td></tr> <tr><td>0x01</td> <td class="td-cmd">ResetInd</td> <td>x</td> <td></td> <td class="td-cmd-desc">ABP设备用于指示对网络的重置并协商协议版本</td></tr> <tr><td>0x01</td> <td class="td-cmd">ResetConf</td> <td></td> <td>x</td> <td class="td-cmd-desc">确认 ResetInd 指令</td></tr> <tr><td>0x02</td> <td class="td-cmd">LinkCheckReq</td> <td>x</td> <td></td> <td class="td-cmd-desc">终端利用这个命令来判断网络连接质量</td></tr> <tr><td>0x02</td> <td class="td-cmd">LinkCheckAns</td> <td></td> <td>x</td> <td class="td-cmd-desc">LinkCheckReq 的回应。包含向终端设备指示接收质量（链路裕度）的接收信号功率估计</td></tr> <tr><td>0x03</td> <td class="td-cmd">LinkADRReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">向终端请求改变数据速率，发射功率，重传率以及信道</td></tr> <tr><td>0x03</td> <td class="td-cmd">LinkADRAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">LinkADRReq 的回应</td></tr> <tr><td>0x04</td> <td class="td-cmd">DutyCycleReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">向终端设置发送的最大占空比</td></tr> <tr><td>0x04</td> <td class="td-cmd">DutyCycleAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">DutyCycleReq 的回应</td></tr> <tr><td>0x05</td> <td class="td-cmd">RXParamSetupReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">向终端设置接收时隙参数</td></tr> <tr><td>0x05</td> <td class="td-cmd">RXParamSetupAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">RXParamSetupReq的回复</td></tr> <tr><td>0x06</td> <td class="td-cmd">DevStatusReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">向终端查询其状态</td></tr> <tr><td>0x06</td> <td class="td-cmd">DevStatusAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">返回终端设备的状态，即电池余量和链路解调裕度。</td></tr> <tr><td>0x07</td> <td class="td-cmd">NewChannelReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">创建或修改 1个射频信道定义</td></tr> <tr><td>0x07</td> <td class="td-cmd">NewChannelAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">NewChannelReq 的回复</td></tr> <tr><td>0x08</td> <td class="td-cmd">RXTimingSetupReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">设置接收时隙的时间</td></tr> <tr><td>0x08</td> <td class="td-cmd">RXTimingSetupAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">RXTimingSetupReq 的回复</td></tr> <tr><td>0x09</td> <td class="td-cmd">TxParamSetupReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">网络服务器用于设置基于当地规定的终端的最大允许驻留时间和最大EIRP</td></tr> <tr><td>0x09</td> <td class="td-cmd">TxParamSetupAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">TxParamSetupReq的回复。</td></tr> <tr><td>0x0A</td> <td class="td-cmd">DlChannelReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">通过从上行链路频率移位下行链路频率（如创建非对称信道）来修改下行链路RX1无线电信道的定义</td></tr> <tr><td>0x0A</td> <td class="td-cmd">DlChannelAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">DlChannelReq 的回复</td></tr> <tr><td>0x0B</td> <td class="td-cmd">RekeyInd</td> <td>x</td> <td></td> <td class="td-cmd-desc">OTA 设备用于发出安全上下文更新信号（Rekeying)</td></tr> <tr><td>0x0B</td> <td class="td-cmd">RekeyConf</td> <td></td> <td>x</td> <td class="td-cmd-desc">RekeyInd 的确认</td></tr> <tr><td>0x0C</td> <td class="td-cmd">ADRParamSetupReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">网络服务器用来设置终端设备的 ADR_ACK_LIMT 和 ADR_ACK_DELAY 参数</td></tr> <tr><td>0x0C</td> <td class="td-cmd">ADRParamSetupAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">应答 ADRParamSetupReq</td></tr> <tr><td>0x0D</td> <td class="td-cmd">DeviceTimeReq</td> <td>x</td> <td></td> <td class="td-cmd-desc">终端设备用于请求当前日期和时间</td></tr> <tr><td>0x0D</td> <td class="td-cmd">DeviceTimeReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">回应 DeviceTimeReq 命令</td></tr> <tr><td>0x0E</td> <td class="td-cmd">ForceRejoinReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">网络发送，要求终端立即通过可选的周期性重试重新入网</td></tr> <tr><td>0x0F</td> <td class="td-cmd">RejoinParamSetupReq</td> <td></td> <td>x</td> <td class="td-cmd-desc">网络用于设置设备周期性重新入网连接消息</td></tr> <tr><td>0x0F</td> <td class="td-cmd">RejoinParamSetupAns</td> <td>x</td> <td></td> <td class="td-cmd-desc">对 RejoinParamSetupReq 命令的应答</td></tr> <tr><td>0x80~0xFF</td> <td>私有</td> <td>x</td> <td>x</td> <td class="td-cmd-desc">给专有网络命令拓展做预留</td></tr></table> <i class="lora-table-name">表4. MAC 指令</i> <blockquote><p><strong>注意：</strong> 一般情况下，终端设备对接收到的 Mac 命令只响应一次。如果答案丢失，则网络必须重新发送该命令。当接收到不包含答案的新上行链路时，网络决定必须重新发送该命令。只有<strong>RxParamSetupReq</strong>、<strong>RxTimingSetupReq</strong> 和 <strong>DlChannelReq</strong> 在它们的相关部分中描述了不同的确认机制，因为它们影响下行参数。</p> <p><strong>注意：</strong> 当终端设备启动 MAC 命令时，网络会尽最大努力在请求之后立即在 RX1/RX2 窗口中发送确认或应答。如果在那个插槽中没有接收到答案，则终端设备可以自由地实现它需要的任何重试机制。</p> <p><strong>注意：</strong> MAC 命令的长度不是显式给定的，必须由 MAC 的实现隐性得知。因此，未知的 MAC 无法跳过，第一个未知的 MAC 命令终止对 MAC 命令序列的处理。因此，建议根据首次引入 MAC 命令的 LoRaWAN 规范的版本来处理 MAC 命令。这样，即使存在只在比实现的规范更新的版本中指定的 MAC 命令，也可以处理到实现的规范版本之前的所有MAC命令。</p></blockquote> <h2 id="_5-1-复位指示"><a href="#_5-1-复位指示" class="header-anchor">#</a> 5.1 复位指示</h2> <p>Reset indication commands：<em><strong>ResetInd, ResetConf</strong></em></p> <p>这一对 MAC 指令仅对在 LoRaWAN1.1 兼容的网络服务上激活的 ABP 设备有效。LoRaWAN1.0 服务没有实现。</p> <p>OTA 设备不能（MUST NOT）实现该指令。网络服务应当（SHALL）忽略来自 OTA 设备的 <em><strong>ResetInt</strong></em> 指令。</p> <p>使用 <em><strong>ResetInd</strong></em> 命令，ABP 终端设备指示网络它已经重新初始化，并且已经切换回默认的 MAC &amp; radio 参数 （即设备制造时的出厂参数，三个帧计数器除外）。<em><strong>ResetInd</strong></em> 指令必须（MUST） 添加至所有上行通信的 <em><strong>FOpt</strong></em> 字段直至收到 ResetConf。</p> <p>此命令不向网络服务器发出下行帧计数器已重置的信号。在 ABP 设备中，帧计数器（上行和下行）永远不能（SHALL NEVER）重置。</p> <blockquote><p><strong>注意</strong>：此命令适用于电源可能在某个时刻中断的ABP设备（例如更换电池）。设备可能会丢失存储在 RAM 中的 MAC 层上下文（除了必须存储在 NVM 中的帧计数器）。这种情况下，设备需要一种方法将上下文丢失传达给网络服务器。在 LoRaWAN 协议的未来版本中，该命令还可以用于在设备和网络服务器之间协商一些协议选项。</p></blockquote> <p><em><strong>ResetInd</strong></em> 指令包含终端设备支持的 LoRaWan 次版本号。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>ResetInd Payload</b></td> <td>Dev LoRaWAN version</td></tr></table> <i class="lora-table-name">图21. ResetInd 载荷格式</i> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>ResetInd Payload</b></td> <td>RFU</td> <td>Minor=1</td></tr></table> <p>Minor 字段指示该设备支持的 LoRaWAN 次版本号。</p> <table class="lora-table"><tr><td><b>Minor version</b></td> <td><b>Minor</b></td></tr> <tr><td>RFU</td> <td>0</td></tr> <tr><td>1 (LoRaWAN x.1)</td> <td>1</td></tr> <tr><td>RFU</td> <td>2:15</td></tr></table> <p>当网络服务器收到 <em><strong>ResetInd</strong></em> 指令时，它回应一个 <em><strong>ResetConf</strong></em> 指令。</p> <p><em><strong>ResetConf</strong></em> 指令包含一个编码了次版本号的单字节载荷，格式与“dev LoRaWAN version”相同。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>ResetConf Payload</b></td> <td>Serv LoRaWAN version</td></tr></table> <i class="lora-table-name">图22. ResetConf 载荷格式</i> <p><em><strong>ResetConf</strong></em> 所携带的服务器端版本号必须与设备提供的相同。所有其它数值均为无效。</p> <p>如果服务端的版本号无效，设备则放弃这条收到的 <em><strong>ResetConf</strong></em>，并在下一个上行帧中重发 <em><strong>ResetInd</strong></em> 指令。</p> <h2 id="_5-2-链路检查"><a href="#_5-2-链路检查" class="header-anchor">#</a> 5.2 链路检查</h2> <p>Link Check Commands，<em><strong>LinkCheckReq, LinkCheckAns</strong></em></p> <p>通过 <em><strong>LinkCheckReq</strong></em> 命令，终端可以知道是否已连接上服务器。该命令没有载荷。</p> <p>当网络服务器通过一个或者多个网关接收到 <em><strong>LinkCheckReq</strong></em> 命令时，它会以 <em><strong>LinkCheckAns</strong></em> 命令进行回复。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>1</td></tr> <tr><td><b>LinkCheckAns Payload</b></td> <td>Margin</td> <td>GwCnt</td></tr></table> <i class="lora-table-name">图23. LinkCheckAns 载荷格式</i> <p>解调余量（ <strong>Margin</strong> ）是一个范围为 0~254 的 8 位无符号整数，表示成功接收最新的 <strong>LinkCheckReq</strong> 命令的链路余量（单位为dB）。</p> <p>若 Margin 值为“0”则意味着数据帧是在解调水平上进行接收（0 dB或者没有预算），当 Margin 值为“20”时则意味着数据帧到达在解调水平之上 20dB 的网关。“255”为保留值。</p> <p>网关计数（<strong>GwCnt</strong>）是成功接收最新的 <em><strong>LinkCheckReq</strong></em> 命令的网关个数。</p> <h2 id="_5-3-数据速率适应"><a href="#_5-3-数据速率适应" class="header-anchor">#</a> 5.3 数据速率适应</h2> <p>Link ADR commands，<em><strong>LinkADRReq, LinkADRAns</strong></em></p> <p>通过 <em><strong>LinkADRReq</strong></em> 命令，网络服务器请求终端设备执行数据速率适应。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>2</td> <td>1</td></tr> <tr><td><b>LinkADRReq Payload</b></td> <td>DataRate_TXPower</td> <td>ChMask</td> <td>Redundancy</td></tr></table> <i class="lora-table-name">图24. LinkADRReq 载荷格式</i> <table class="lora-table"><tr><td><b>Bits</b></td> <td>[7:4]</td> <td>[3:0]</td></tr> <tr><td><b>DataRate_TXPower</b></td> <td>DataRate</td> <td>TXPower</td></tr></table> <p>所请求的数据速率（<strong>DataRate</strong>）和发射功率（<strong>TXPower</strong>）是区域限定的，体现在 [PHY-DOC] 中。命令中的发射功率字段指的是设备可操作的最大发射功率。如果命令中的发射功率高于终端所使用的最大发射功率，终端也要（MUST）应答成功，这种情况下，将终端的发射功率提高至其可能的最大值。DataRate 或 TXPower 取值 0xF（十进制的 15）表示设备要（MUST）忽略该字段，并保持当前参数不变。</p> <p>频道掩码对上行通信可用的通道编码如下，与 LSB 对应的位为 0:</p> <table class="lora-table"><tr><td><b>Bit#</b></td> <td><b>Usable channels</b></td></tr> <tr><td>0</td> <td>Channel 1</td></tr> <tr><td>1</td> <td>Channel 2</td></tr> <tr><td>..</td> <td>..</td></tr> <tr><td>15</td> <td>Channel 16</td></tr></table> <i class="lora-table-name">表5. 信道状态表</i> <p>ChMask 字段的对应位如果设置为1，则表示对应的信道可以进行上行传输，只要该信道允许终端使用该数据速率。如果对应位设置为0，则表示相应信道不可用。</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7</td> <td>[6:4]</td> <td>[3:0]</td></tr> <tr><td><b>Redundancy bits</b></td> <td>RFU</td> <td>ChMaskCntl</td> <td>NbTrans</td></tr></table> <p>Redundancy 字段中的 <strong>NbTrans</strong> 位域，指的是每个上行消息的发送次数，这仅对 “confirmed”或“unconfirmed”消息起作用。这个字段的默认值为1，相对应的是每个数据帧只进行单次传输。有效取值范围是[1:15]。如果收到 <strong>NbTrans</strong> == 0，终端则（SHALL）保持当前 NbTrans 值不变。</p> <p>信道控制掩码（<strong>ChMaskCntl</strong>）段控制前面定义的 ChMask 位掩码的解释。它控制了 ChMask 应用的 16 个信道块。也可以对所用信道进行全局的打开或关闭。这个字段的使用有区域限定，定义在 [PHY-DOC] 中。</p> <p>网络服务器可能会在单个下行帧中包含多个 LinkADRReq 命令。终端为了配置 channel mask ，要（MUST）按照下行消息中的命令出现的顺序逐一地处理所有的 LinkADRReq 消息，作为单个原子块命令。网络服务器不能（MUST NOT）在下行消息中包含一个以上的原子块命令。终端设备则必须（MUST）发送一个 LinkADRAns 命令来接受或拒绝整个 ADR 原子命令块。如果下行消息携带多个 ADR 原子命令块，终端设备应（SHALL）只处理第一个 ADR 原子命令块，并发送一个 NAck（一个所有状态位设置为 0 的 <em><strong>LinkADRAns</strong></em> 命令）响应所有其他 ADR 命令块。</p> <p>设备必须（MUST）只处理来自连续 ADR 命令块中的最后一个 LinkADRReq 命令的 DataRate、TXPower 和 NbTrans，因为这些设置控制这些值的终端设备全局状态。</p> <p>响应中的信道掩码 ACK 位必须（MUST）反映出按顺序处理连续 ADR 命令块中<strong>所有</strong>通道掩码控制之后的接受/拒绝最终信道计划。</p> <p>信道频点信息是按地区制定的，具体定义在 [PHY-DOC]。终端使用 <em><strong>LinkADRAns</strong></em> 指令来应答 <em><strong>LinkADRReq</strong></em> 指令。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>LinkADRAns Payload</b></td> <td>Status</td></tr></table> <i class="lora-table-name">图25. LinkADRAns 载荷格式</i> <table class="lora-table"><tr><td><b>Bits</b></td> <td>[7:3]</td> <td>2</td> <td>1</td> <td>0</td></tr> <tr><td><b>Status bits</b></td> <td>RFU</td> <td>Power ACK</td> <td>Data rate ACK</td> <td>Channel mask ACK</td></tr></table> <p><em><strong>LinkADRAns</strong></em> 的 <strong>Status</strong> 字段含义如下：</p> <table class="lora-table"><tr><td></td> <td><b>Bit = 0</b></td> <td><b>Bit = 1</b></td></tr> <tr><td><b>Channel mask ACK</b></td> <td class="td-desc">所发的 channel mask 使能了未定义的信道或者禁用了所有信道。命令被丢弃，终端状态不变</td> <td class="td-desc">所发的 channel mask 已成功解析，已按照 mask 设置了当前的信道状态</td></tr> <tr><td><b>Data rate ACK</b></td> <td class="td-desc">所请求的数据速率，终端无法识别，或者无法应用在当前信道中（不被任何使能的信道支持)。命令被丢弃，终端状态不变</td> <td class="td-desc">数据速率成功设置，或 DataRate 字段被设置为 15，意思是被忽略</td></tr> <tr><td><b>Power ACK</b></td> <td class="td-desc">设备无法执行或低于所请求的发射功率。命令被丢弃，终端状态不变</td> <td class="td-desc">设备能够执行或低于所请求的发射功率，或请求的 TXPower 字段设置为 15，表示应该忽略</td></tr></table> <i class="lora-table-name">表6. LinkADRAns 状态位含义</i> <p>如果这三个位中有任何一位等于0，则 <em><strong>LinkADRReq</strong></em> 命令没有成功，节点保持之前的状态。</p> <h2 id="_5-4-终端发射占空比"><a href="#_5-4-终端发射占空比" class="header-anchor">#</a> 5.4 终端发射占空比</h2> <p>End-Device Transmit Duty Cycle，<em><strong>DutyCycleReq, DutyCycleAns</strong></em></p> <p><em><strong>DutyCycleReq</strong></em> 命令被网络协调者用来限制终端的最大总计发射占空比。最大总计发射占空比覆盖所有子频段上的发射占空比。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>DutyCycleReq Payload</b></td> <td>DutyCyclePL</td></tr></table> <i class="lora-table-name">图26. DutyCycleReq 载荷格式</i> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>DutyCyclePL</b></td> <td>RFU</td> <td>MaxDCycle</td></tr></table> <p>终端所允许的最大发射占空比为：</p> <p></p><p><mjx-container jax="SVG" display="true" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="34.696ex" height="4.877ex" viewBox="0 -1342 15335.8 2155.7" style="vertical-align:-1.841ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(529, 0)"><path data-c="67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(1006, 0)"><path data-c="67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(1483, 0)"><path data-c="72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1934, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(2400, 0)"><path data-c="67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(2877, 0)"><path data-c="61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(3406, 0)"><path data-c="74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(3767, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(4233, 0)"><path data-c="64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(4753, 0)"><path data-c="44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></g><g data-mml-node="mi" transform="translate(5581, 0)"><path data-c="75" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(6153, 0)"><path data-c="74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(6514, 0)"><path data-c="79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(7004, 0)"><path data-c="43" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(7719, 0)"><path data-c="79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(8209, 0)"><path data-c="63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(8642, 0)"><path data-c="6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g><g data-mml-node="mi" transform="translate(8940, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mo" transform="translate(9683.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(10739.6, 0)"><g data-mml-node="mn" transform="translate(2048.1, 676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="msup" transform="translate(220, -813.7)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(500, 363) scale(0.707)"><g data-mml-node="mi"><path data-c="4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mi" transform="translate(1051, 0)"><path data-c="61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(1580, 0)"><path data-c="78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mi" transform="translate(2152, 0)"><path data-c="44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></g><g data-mml-node="mi" transform="translate(2980, 0)"><path data-c="63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(3413, 0)"><path data-c="79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3903, 0)"><path data-c="63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(4336, 0)"><path data-c="6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g><g data-mml-node="mi" transform="translate(4634, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g></g></g><rect width="4356.2" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></p><p></p> <p><strong>MaxDutyCycle</strong> 的有效取值范围为[0:15]。MaxDutyCycle的值若为0则表示“无发射占空比限制”，除非各地区有对发射占空比进行限制。</p> <p>终端使用 <em><strong>DutyCycleAns</strong></em> 指令回复 <em><strong>DutyCycleReq</strong></em>。<em><strong>DutyCycleAns</strong></em> 指令不包含任何载荷。</p> <h2 id="_5-5-接收窗口参数"><a href="#_5-5-接收窗口参数" class="header-anchor">#</a> 5.5 接收窗口参数</h2> <p>Receive Windows Parameters，<em><strong>RXParamSetupReq, RXParamSetupAns</strong></em></p> <p><em><strong>RXParamSetupReq</strong></em> 命令可以对每个上行消息之后的第二接收窗口（RX2）的频率以及数据速率进行改变。该命令还可以对上行数据速率和（RX1）下行数据速率的偏移量进行改变。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>3</td></tr> <tr><td><b>RXParamSetupReq Payload</b></td> <td>DLsettings</td> <td>Frequency</td></tr></table> <i class="lora-table-name">图26. RXParamSetupReq 载荷格式</i> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7</td> <td>6:4</td> <td>3:0</td></tr> <tr><td><b>DLsettins</b></td> <td>RFU</td> <td>RX1DRoffset</td> <td>RX2DataRate</td></tr></table> <p><strong>RX1DRoffset</strong> 字段设置上行数据速率和第一时隙（RX1）与终端通讯的下行数据速率的偏移量。默认情况下偏移量为0（意思就是上行数据速率与下行数据速率相等)。偏移量用于考虑一些地区的基站最大功率密度限制和平衡上下行射频链路预算。</p> <p><strong>RX2DataRate</strong> 字段定义了第二接收窗口的下行链路数据速率，遵循与 <em><strong>LinkADRReq</strong></em> 指令相同的规则（例如，0表示DR0/125kHz)。<strong>Frequency</strong> 字段所设置的是第二接收窗口所使用信道的频率，该频率按照与 <em><strong>NewChannelReq</strong></em> 指令相同的规则进行定义。</p> <p>终端使用 <em><strong>RXParamSetupAns</strong></em> 指令对 <em><strong>RXParamSetupReq</strong></em> 指令进行应答。<em><strong>RXParamSetupAns</strong></em> 指令必须（MUST）添加在所有的上行链路数据帧的 <strong>Fopt</strong> 字段中直到终端接收到一个Class A类型的下行链路数据帧。这样就可以保证即使在上行链路帧丢失的情况之下，网络服务器总是可以知道终端所使用的下行链路参数。</p> <p>命令的载荷为1字节的状态信息。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>RXParamSetupAns Payload</b></td> <td>Status</td></tr></table> <i class="lora-table-name">图28. RXParamSetupAns 载荷格式</i> <p><strong>Status</strong> 各位的含义如下：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:3</td> <td>2</td> <td>1</td> <td>0</td></tr> <tr><td><b>Status bits</b></td> <td>RFU</td> <td>RX1DRoffset ACK</td> <td>RX2 Data Rate ACK</td> <td>Channel ACK</td></tr></table> <table class="lora-table"><tr><td></td> <td><b>Bit = 0</b></td> <td><b>Bit = 1</b></td></tr> <tr><td><b>Channel ACK</b></td> <td>终端无法使用请求的频率</td> <td>RX2时隙信道频率设置成功</td></tr> <tr><td><b>RX2 Data rate ACK</b></td> <td>终端无法识别请求的数据速率</td> <td>RX2时隙数据速率设置成功</td></tr> <tr><td><b>RX1DRoffset ACK</b></td> <td>上行数据速率与RX1下行数据速率的偏移量不在允许的范围之内</td> <td>RX1DRoffset设置成功</td></tr></table> <i class="lora-table-name">表7. RXParamSetupAns status bits signification</i> <p>如果3个位的任何一位为0，则 <em><strong>RXParamSetupReq</strong></em> 指令不成功，节点保持之前的状态。</p> <h2 id="_5-6-终端状态"><a href="#_5-6-终端状态" class="header-anchor">#</a> 5.6 终端状态</h2> <p>End-Device Status，<em><strong>DevStatusReq, DevStatusAns</strong></em></p> <p>通过 <em><strong>DevStatusReq</strong></em> 命令，网络服务器向终端设备请求状态信息。该命令无载荷。一旦终端收到 <em><strong>DevStatusReq</strong></em> 命令，则必须（MUST）回复 <em><strong>DevStatusAns</strong></em> 命令。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>1</td></tr> <tr><td><b>DevStatusAns Payload</b></td> <td>Battery</td> <td>Margin</td></tr></table> <i class="lora-table-name">图29. DevStatusAns payload format</i> <p>报告电池电量（<strong>Battery</strong>）以如下方式编码:</p> <table class="lora-table"><tr><td><b>Battery</b></td> <td><b>Description</b></td></tr> <tr><td>0</td> <td>终端连接到外部电源</td></tr> <tr><td>1..254</td> <td>数值表示电池电量，1表示最低，254表示最高</td></tr> <tr><td>255</td> <td>终端无法测量电池电量</td></tr></table> <i class="lora-table-name">表8. 电池电量码表</i> <p><strong>Margin</strong> 是最近一次成功接收 <em><strong>DevStatusReq</strong></em> 命令的解调信噪比（该值必须是四舍五入到最近的整数值，单位为dB）。它是6位的有符号整数（最小值为 -32，最大值为31）。</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:6</td> <td>5:0</td></tr> <tr><td><b>Status bits</b></td> <td>RFU</td> <td>Margin</td></tr></table> <h2 id="_5-7-信道的创建和修改"><a href="#_5-7-信道的创建和修改" class="header-anchor">#</a> 5.7 信道的创建和修改</h2> <p>Creation / Modification of a Channel， <em><strong>NewChannelReq, NewChannelAns, DlChannelReq, DlChannelAns</strong></em></p> <p>在已定义固定信道计划的区域内运行的设备不应（SHALL NOT）实现和响应这些 MAC 命令。参阅 [PHY-DOC]。</p> <p><strong>NewChannelReq</strong> 命令可以用于修改现有的双向信道或者创建一个新的信道。这个命令设置了新信道的中心频率还有上行数据速率的可用范围：</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>3</td> <td>1</td></tr> <tr><td><b>NewChannelReq Payload</b></td> <td>Chlndex</td> <td>Freq</td> <td>DrRange</td></tr></table> <i class="lora-table-name">图30. NewChannelReq payload format</i> <p>信道索引 <strong>Chlndex</strong> 是正在创建或者正在修改的信道的索引。根据所使用的区域和频带，某些地区（参阅 [PHY-DOC]），LoRaWAN规范强加了所有设备通用的默认信道，该信道不能被 <em><strong>NewChannelReq</strong></em> 命令修改。如果默认信道的个数为 N，则默认信道的编号从0 到 N-1，并且 <strong>ChIndex</strong> 的可接受范围为 N 到 15。一个设备必须至少能处理 16 个不同的信道定义。在某些特定的区域，设备可能必须存储超过 16 个信道定义。</p> <p><strong>Freq</strong> 字段是一个 24 位无符号整数。实际信道频率为（100 × <strong>Freq</strong>），单位为HZ，其中低于 100MHz 的频率数值将会保留供将来使用。<strong>Freq</strong> 可以设置从100MHz到1.67GHz之间的信道频率，但必须以100Hz为单位。Freq 为零则禁用该信道。终端必须检测该频率是否能被射频硬件所使用，若不行则需返回错误。</p> <p>数据速率范围 <strong>DrRange</strong> 字段规定了这个信道所允许的上行数据速率范围。该位域被分为两个 4 位字段：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>DrRange</b></td> <td>MaxDR</td> <td>MinDR</td></tr></table> <p>按照<a href="#_5-3-%E6%95%B0%E6%8D%AE%E9%80%9F%E7%8E%87%E9%80%82%E5%BA%94">章节5.3</a>所定义的规则，最小数据速率（<strong>MinDR</strong>）字段规定了这个信道所允许的最低上行数据速率。例如使用欧洲区域参数，0 表示 DR0/125kHz。类似的，最大数据速率（<strong>MaxDR</strong>）规定了最高上行数据速率。例如，若<strong>DrRange</strong>=0x77则表示一个信道只允许 50kbps 的 GFSK；若 <strong>DrRange</strong>=0x50 表示一个信道支持 DR0/125kHz 到 DR5/125kHZ 的频率范围。</p> <p>最近定义以及修改的信道被使能之后可以立刻用于通信。RX1 的下行频率与上行频率相等。</p> <p>终端以 <em><strong>NewChannelAns</strong></em> 指令对 <em><strong>NewChannelReq</strong></em> 进行应答。<em><strong>NewChannelAns</strong></em> 指令的载荷包含以下信息：</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>NewChannelAns Payload</b></td> <td>Status</td></tr></table> <i class="lora-table-name">图31. NewChannelAns payload format</i> <p><strong>Status</strong>位有以下含义：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:2</td> <td>1</td> <td>0</td></tr> <tr><td><b>Status</b></td> <td>RFU</td> <td>Data rate range ok</td> <td>Channel frequency ok</td></tr></table> <table class="lora-table"><tr><td></td> <td>Bit = 0</td> <td>Bit = 1</td></tr> <tr><td><b>Data rate range ok</b></td> <td>指定的数据速率超出了终端当前定义的范围</td> <td>该数据速率与终端能够兼容</td></tr> <tr><td><b>Channel frequency ok</b></td> <td>终端无法使用该频率</td> <td>终端能够使用该频率</td></tr></table> <i class="lora-table-name">表9. NewChannelAns status bits signification</i> <p>如果以上两位其中之一为 0，则 <em><strong>NewChannelReq</strong></em> 命令不成功，新的信道将不会产生。</p> <p><em><strong>DlChannelReq</strong></em> 命令允许服务器在 RX1 时隙使用不同的下行链路频率。这个命令可以适用于所有支持 <em><strong>NewChannelReq</strong></em> 命令物理层（例如欧盟和中国，但是不适用于美国和澳大利亚）。</p> <p>该命令用于设置 RX1 时隙的下行消息中心频率：</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>3</td></tr> <tr><td><b>DlChannelReq Payload</b></td> <td>Chlndex</td> <td>Freq</td></tr></table> <i class="lora-table-name">图32. DLChannelReq payload format</i> <p><strong>ChIndex</strong> 是要修改下行频率的信道的索引。</p> <p>频率 <strong>Freq</strong> 字段是24位的无符号整数。实际信道频率为 100×<strong>Freq</strong>，单位为Hz，其中表示低于 100MHz 的频率数值保留供将来使用。终端必须检测该频率是否能被射频硬件所使用，若不行则需返回错误。</p> <p>终端以 <em><strong>DlChannelAns</strong></em> 命令对 <em><strong>DlChannelReq</strong></em> 命令进行应答。<em><strong>DlChannelAns</strong></em> 必须（MUST）加入所有上行通信的 FOpt 字段直到终端接收到一个下行数据包。这样才能保证在上行数据包丢失的情况之下，网络服务器总是能够知道终端所使用的下行频率。</p> <p>该命令的载荷包含如下信息：</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>DlChannelAns Payload</b></td> <td>Status</td></tr></table> <i class="lora-table-name">图33. DLChannelAns payload format</i> <p><strong>Status</strong> 位有以下的含义：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:2</td> <td>1</td> <td>0</td></tr> <tr><td><b>Status</b></td> <td>RFU</td> <td>上行频率可用</td> <td>信道频率可用</td></tr></table> <table class="lora-table"><tr><td></td> <td>Bit = 0</td> <td>Bit = 1</td></tr> <tr><td><b>Channel frequency ok</b></td> <td>终端无法使用该频率</td> <td>终端无法使用该频率</td></tr> <tr><td><b>Uplink frequency exists</b></td> <td>该信道无法使用此上行频率，只能为已经具有一个有效上行频率的信道设置下行频率</td> <td>信道的上行频率有效</td></tr></table> <i class="lora-table-name">表10. DlChannelAns status bits signification</i> <h2 id="_5-8-tx-和-rx-之间的延时设置"><a href="#_5-8-tx-和-rx-之间的延时设置" class="header-anchor">#</a> 5.8 TX 和 RX 之间的延时设置</h2> <p>Setting delay between TX and RX，<em><strong>RXTimingSetupReq</strong></em>，<em><strong>RXTimingSetupAns</strong></em></p> <p><em><strong>RXTimingSetupReq</strong></em> 命令允许配置 TX 上行链路发送完毕之后与第一个接收窗口打开之间的延时。第二接收窗口在第一接收窗口之后的1秒打开。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>RXTimingSetupReq Payload</b></td> <td>Settings</td></tr></table> <i class="lora-table-name">图34. RXTimingSetupReq payload format</i> <p>延迟（<strong>Delay</strong>）字段指定延时时间。这个字段被分为两个4位字段：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>Settings</b></td> <td>RFU</td> <td>Del</td></tr></table> <p>延时时间的单位为秒。Del的值为0时对应的延时时间为1s。</p> <table class="lora-table"><tr><td><b>Del</b></td> <td><b>Delay[s]</b></td></tr> <tr><td>0</td> <td>1</td></tr> <tr><td>1</td> <td>1</td></tr> <tr><td>2</td> <td>2</td></tr> <tr><td>3</td> <td>3</td></tr> <tr><td>..</td> <td>..</td></tr> <tr><td>15</td> <td>15</td></tr></table> <i class="lora-table-name">表11. RXTimingSetup Delay mapping table</i> <p>终端用于应答 <em><strong>RXTimingSetupReq</strong></em> 命令的 <em><strong>RXTimingSetupAns</strong></em> 命令没有载荷。</p> <p><em><strong>RXTimingSetupAns</strong></em> 命令应该添加所有上行通信的 <strong>FOpt</strong> 字段，直到接收到一个下行数据。这样才能保证在上行数据包丢失的情况之下，网络服务器总是能够知道终端所使用的下行参数。</p> <h2 id="_5-9-终端发射参数"><a href="#_5-9-终端发射参数" class="header-anchor">#</a> 5.9 终端发射参数</h2> <p>End-device transmission parameters，<em><strong>TxParamSetupReq, TxParamSetupAns</strong></em></p> <p>该命令只需要在特定的受控地区使用。具体请参考 [PHY-DOC]。</p> <p><em><strong>TxParamSetupReq</strong></em> 可以用于通知终端的最大允许驻留时间，即，一个数据包在空中的最大持续传输时间,以及终端所允许的最大<strong>全向有效辐射功率(EIRP)</strong>。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>TxParamSetup payload</b></td> <td>EIRP_DwellTime</td></tr></table> <i class="lora-table-name">图35. TxParamSetupReq payload format</i> <p><strong>EIRP_DwellTime</strong> 字段的结构如下所述：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:6</td> <td>5</td> <td>4</td> <td>3:0</td></tr> <tr><td><b>MaxDwellTime</b></td> <td>RFU</td> <td>DownlinkDwellTime</td> <td>UplinkDwellTime</td> <td>MaxEIRP</td></tr></table> <p><em><strong>TxParamSetupReq</strong></em> 命令的 [0..3] 位是用于表示 <strong>EIRP</strong> 的最大值，每个编码值对应的最大<strong>EIRP</strong>值的映射表如下。这张表中的最大 <strong>EIRP</strong> 的值的变化范围由各个地区来进行自行规定。</p> <table class="lora-table"><tr><td><b>Coded Value</b></td> <td>0</td> <td>1</td> <td>2</td> <td>3</td> <td>4</td> <td>5</td> <td>6</td> <td>7</td> <td>8</td> <td>9</td> <td>10</td> <td>11</td> <td>12</td> <td>13</td> <td>14</td> <td>15</td></tr> <tr><td><b>Max EIRP(dBm)</b></td> <td>8</td> <td>10</td> <td>12</td> <td>13</td> <td>14</td> <td>16</td> <td>18</td> <td>20</td> <td>21</td> <td>24</td> <td>26</td> <td>27</td> <td>29</td> <td>30</td> <td>33</td> <td>36</td></tr></table> <i class="lora-table-name">表12. TxParamSetup EIRP encoding table</i> <p>最大 <strong>EIRP</strong> 指的是设备无线电发射功率的上限。设备不需要使用该功率进行传输，但是绝不会辐射超过指定的 EIRP。</p> <p>第4位和第5位分别定义了上行链路和下行链路的驻留时间，驻留时间的映射编码表如下所示：</p> <table class="lora-table"><tr><td><b>Coded Value</b></td> <td><b>Dwell Time</b></td></tr> <tr><td>0</td> <td>No Limit</td></tr> <tr><td>1</td> <td>400 ms</td></tr></table> <p>如果实现了该 MAC 指令（因区域而定），终端会以 <em><strong>TxParamSetupAns</strong></em> 命令对 <em><strong>TxParamSetupReq</strong></em> 命令进行回复。<em><strong>TxParamSetupAns</strong></em> 指令不包含载荷。</p> <p>当在某个区域内是不需要 <em><strong>TxParamSetupReq</strong></em> 命令时，则终端不会对该命令进行任何处理并且不会进行回复。</p> <h2 id="_5-10-秘钥更新指示"><a href="#_5-10-秘钥更新指示" class="header-anchor">#</a> 5.10 秘钥更新指示</h2> <p>Rekey indication commands，<em><strong>RekeyInd</strong></em>，<em><strong>RekeyConf</strong></em></p> <p>此 MAC 指令仅适用于在兼容 LoRaWAN1.1 的网络服务器上激活的 OTA 设备。LoRaWAN1.0 服务器没有实现这个 MAC 指令。</p> <p>ABP 设备不（MUST NOT）实现该指令。网络服务器应该忽略来自 ABP 设备的 <em><strong>RekeyInd</strong></em> 指令。</p> <p>对于 OTA 设备，<em><strong>RekeyInd</strong></em> 指令用于确认安全密钥更新，在未来的协议版本（&gt;1.1）中，还将用于协商在终端设备和网络服务器之间运行的LoRaWAN协议次版本号。该命令不发出重置MAC &amp; radio 参数的信号（参见 6.2.3）。</p> <p><em><strong>RekeyInd</strong></em> 指令包含终端设备支持的 LoRaWAN 协议次版本号.</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>RekeyInd Payload</b></td> <td>Dev LoRaWAN version</td></tr></table> <i class="lora-table-name">图36. RekeyInd payload format</i> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>Dev LoRaWAN version</b></td> <td>RFU</td> <td>Minor=1</td></tr></table> <p>Minor 字段表示终端设备支持的 LoRaWAN 版本的次版本号。</p> <table class="lora-table"><tr><td><b>Minor version</b></td> <td><b>Minor</b></td></tr> <tr><td>RFU</td> <td>0</td></tr> <tr><td>1 (LoRaWAN x.1)</td> <td>1</td></tr> <tr><td>RFU</td> <td>2:15</td></tr></table> <p>OTA 设备应在（SHALL）成功处理 Join-accept 会话之后（派生了新的会话密钥），在所有已确认和未确认上行帧中发送 <em><strong>RekeyInd</strong></em>，直到接收到 <em><strong>RekeyConf</strong></em> 为止。如果设备在第一个 ADR_ACK_LIMIT 上行通信中没有收到 <em><strong>RekeyConf</strong></em>，那么它将恢复到 Join 状态。在以后的任何时候，这些设备发送的 <em><strong>RekeyInd</strong></em> 命令都将（SHALL）被网络服务器丢弃。网络服务器应（SHALL）丢弃任何受新安全上下文保护的上行帧，这些上行帧在<strong>Join-accept</strong> 传输之后以及携带 <em><strong>RekeyInd</strong></em> 命令的第一个上行帧之前接收。</p> <p>当网络服务器接收到 <em><strong>RekeyInd</strong></em> 指令，就以一个 <em><strong>RekeyConf</strong></em> 指令应答。</p> <p><em><strong>RekeyConf</strong></em> 指令包含一个单字节载荷，该载荷编码网络服务器支持的 LoRaWAN 版本，使用与“dev LoRaWan version”相同的格式。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>RekeyConf Payload</b></td> <td>Serv LoRaWAN version</td></tr></table> <i class="lora-table-name">图37. RekeyConf payload format</i> <p>服务器版本必须大于0（不允许为0），小于或等于（&lt;=）设备的 LoRaWAN 版本。因此，对于LoRaWAN1.1 设备，惟一的有效值是 1。如果服务器的版本无效，设备将丢弃 <em><strong>RekeyConf</strong></em> 命令，并在下一个上行帧中重新传输 <em><strong>RekeyInd</strong></em>。</p> <h2 id="_5-11-adr-参数"><a href="#_5-11-adr-参数" class="header-anchor">#</a> 5.11 ADR 参数</h2> <p>ADR parameters, <em><strong>ADRParamSetupReq</strong></em>，<em><strong>ADRParamSetupAns</strong></em></p> <p><em><strong>ADRParamSetupReq</strong></em> 指令允许更改定义 ADR 回退算法的 ADR_ACK_LIMIT 和 ADR_ACK_DELAY 参数。<em><strong>ADRParamSetupReq</strong></em> 指令有一个单字节载荷。</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td></tr> <tr><td><b>ADRParamSetupReq Payload</b></td> <td>ADRparam</td></tr></table> <i class="lora-table-name">图38. ADRParamSetupReq payload format</i> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>ADRparam</b></td> <td>Limit_exp</td> <td>Delay_exp</td></tr></table> <p>Limit_exp 字段设置 ADR_ACK_LIMIT 参数值：</p> <p><code>ADR_ACK_LIMIT = 2^Limit_exp</code></p> <p>Limit_exp 的有效取值范围是 0 到 15，对应于 ADR_ACK_LIMIT 的范围是 1 到 32768。</p> <p>Delay_exp 字段设置 ADR_ACK_DELAY 参数值：</p> <p><code>ADR_ACK_DELAY = 2^Delay_exp</code></p> <p>Delay_exp 的有效取值范围是 0 到 15，对应于 ADR_ACK_DELAY 的范围是 1 到 32768。</p> <p>终端设备使用 <em><strong>ADRParamSetupAns</strong></em> 指令令来确认 <em><strong>ADRParamSetupReq</strong></em> 指令的接收。<em><strong>ADRParamSetupAns</strong></em> 指令没有载荷。</p> <h2 id="_5-12-设备时间"><a href="#_5-12-设备时间" class="header-anchor">#</a> 5.12 设备时间</h2> <p>DeviceTime commands, <em><strong>DeviceTimeReq</strong></em>，<em><strong>DeviceTimeAns</strong></em></p> <p>此 MAC 指令仅适用于在兼容 LoRaWAN1.1 的网络服务器上激活的 OTA 设备。LoRaWAN1.0 服务器没有实现这个 MAC 指令。</p> <p>使用 <em><strong>DeviceTimeReq</strong></em> 命令，终端设备可以从网络请求当前网络日期和时间。该请求没有载荷。</p> <p>使用 <em><strong>DeviceTimeAns</strong></em> 命令，网络服务器向终端设备提供网络日期和时间。所提供的时间是上行传输结束时捕获的网络时间。该命令的有效负载为 5 字节，定义如下:</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>4</td> <td>1</td></tr> <tr><td><b>DeviceTimeAns Payload</b></td> <td>32-bit unsigned integer : Seconds since epoch*</td> <td>8bits unsigned integer: fractional- second in 1⁄2^8 second steps</td></tr></table> <i class="lora-table-name">图39. DeviceTimeAns payload format</i> <p>网络提供的时间必须（MUST）具备 +/-100mSec 的最坏情况精度。</p> <p>（*）GPS纪元（即1月6日星期日午夜）被用作原点。“seconds”字段是自原点起经过的秒数。这个字段每秒增加1。要将此字段转换为UTC时间，必须考虑闰秒。</p> <blockquote><p>Example: Friday 12th of February 2016 at 14:24:31 UTC corresponds to 1139322288 seconds since GPS epoch. As of June 2017, the GPS time is 17seconds ahead of UTC time.</p></blockquote> <h2 id="_5-13-强制重连"><a href="#_5-13-强制重连" class="header-anchor">#</a> 5.13 强制重连</h2> <p>Force Rejoin Command, <em><strong>ForceRejoinReq</strong></em></p> <p>使用强制重连指令，网络要求设备立即发送 Rejoin-Request Type 0 或 Type 2 消息，其中包含可编程的重试次数、周期性和数据速率。这个 RejoinReq 上行通信可以被网络用来立即重设设备密钥或启动切换漫游过程。</p> <p>此命令包含两字节载荷：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>15:14</td> <td>13:11</td> <td>10:8</td> <td>7</td> <td>6:4</td> <td>3:0</td></tr> <tr><td><b>ForceRejoinReq bits</b></td> <td>RFU</td> <td>Period</td> <td>Max_Retries</td> <td>RFU</td> <td>RejoinType</td> <td>RFU</td></tr></table> <i class="lora-table-name">图40. ForceRejoinReq payload format</i> <p>参数按下述方式编码：</p> <p>Period: 重新传输之间的延迟应等于 （32秒 × 2^Period + Rand32），其中 Rand32 是[0:32]范围内的伪随机数。</p> <p>Max_Retries: 设备重试 Rejoin-Request 的总次数：</p> <ul><li>0 : Rejoin 仅发送一次（无重试）</li> <li>1 : Rejoin 要（MUST）发送 2 次（1 + 1 重试）</li> <li>……</li> <li>7: Rejoin 要（MUST） 发送 8 times （1 + 7 重试）</li></ul> <p>RejoinType: 此字段指定应由设备传输的 Rejoin-Request 类型。</p> <ul><li>0 or 1 : A Rejoin-request type 0 shall be transmitted</li> <li>2 : A Rejoin-request type 2 shall be transmitted</li> <li>3 to 7 : RFU</li></ul> <p>DR: Rejoin-request 帧应（SHALL）使用数据速率 DR 传输。实际物理调制数据速率和 DR 值之间的对应关系遵循与 LinkADRReq 命令相同的约定，并在 [PHY-DOC] 中为每个区域定义。</p> <p>该命令没有响应，因为设备在收到该命令时必须（MUST）发送一个 Rejoin-Request。RejoinReq 消息的首次发送应在接收到命令后立即进行（但网络可能不会接收到）。如果设备在达到传输重试次数限制之前收到一个新的 ForceRejoinReq 命令，设备应（SHALL）使用新的参数恢复 RejoinReq 的传输。</p> <h2 id="_5-14-重连参数设置"><a href="#_5-14-重连参数设置" class="header-anchor">#</a> 5.14 重连参数设置</h2> <p><em><strong>RejoinParamSetupReq</strong></em>，<em><strong>RejoinParamSetupAns</strong></em></p> <p>使用 <em><strong>RejoinParamSetupReq</strong></em> 命令，网络可以请求设备周期性地发送 RejoinReq Type 0 消息，其可编程周期可以为一段时间或若干上行通信。</p> <p>使用时间和计数两种方法是为了处理可能没有时间测量能力的器件。指定的周期设定两个 RejoinReq 传输之间的最大上行时间或上行次数。设备可以（MAY）更频繁地发送 RejoinReq。</p> <p>该指令有一个单字节载荷：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:4</td> <td>3:0</td></tr> <tr><td><b>RejoinParamSetupReq bits</b></td> <td>MaxTimeN</td> <td>MaxCountN</td></tr></table> <i class="lora-table-name">图41. RejoinParamSetupReq payload format</i> <p>参数定义如下：</p> <p>MaxCountN = C = 0 to 15；设备必须（MUST）至少每2^(C+4) 次上行消息发送一次 Rejoin-Request type 0。
MaxTimeN = T = 0 to 15；设备（必须）至少每 2^(T+10) 秒发送一次 Rejoin-request type 0。</p> <ul><li>T = 0 大约相当于 17 分钟</li> <li>T = 15 大约 1 年</li></ul> <p>每当满足这两个条件（帧数或时间）之一时，就会发送一个 RejoinReq 包。</p> <p>设备必须（MUST）实现计数方式的周期。基于时间的周期是可选的。不能实现时间周期的设备必须在回应中发出信号。</p> <p>回应有一个单字节载荷：</p> <table class="lora-table"><tr><td><b>Bits</b></td> <td>7:1</td> <td>0</td></tr> <tr><td><b>Status bits</b></td> <td>RFU</td> <td>TimeOK</td></tr></table> <i class="lora-table-name">图42. RejoinParamSetupAns payload format</i> <p>如果 Bit 0 = 1，设备接受计时和计次。否则它仅接受计次。</p> <blockquote><p><strong>注意</strong>：对于消息速率非常低且没有时间测量能力的设备，LoRaWAN 中没有指定就最佳计数限制达成一致的机制。</p></blockquote></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/deltacat/lora-docs/edit/master/docs/lorawan-v1.1/ch05.md" target="_blank" rel="noopener noreferrer">帮我改善此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">9/27/2019, 9:49:31 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lorawan-v1.1/ch04.html" class="prev">
        第4章 MAC 帧格式
      </a></span> <span class="next"><a href="/lorawan-v1.1/ch06.html">
        第6章 终端激活
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.741f693f.js" defer></script><script src="/assets/js/2.1bc0aca8.js" defer></script><script src="/assets/js/25.7d1c55c4.js" defer></script>
  </body>
</html>
