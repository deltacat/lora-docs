<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第4章 MAC 帧格式 | LoRa 中文资料汇编</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="LoRa 中文资料汇编。包含 LoRaWAN 1.1 Spec 中文版（翻译）等。持续更新。">
    <link rel="preload" href="/assets/css/0.styles.f1e15b89.css" as="style"><link rel="preload" href="/assets/js/app.741f693f.js" as="script"><link rel="preload" href="/assets/js/2.1bc0aca8.js" as="script"><link rel="preload" href="/assets/js/24.b81b8f52.js" as="script"><link rel="prefetch" href="/assets/js/10.23e15bef.js"><link rel="prefetch" href="/assets/js/11.a713a811.js"><link rel="prefetch" href="/assets/js/12.2c5eaff8.js"><link rel="prefetch" href="/assets/js/13.3bb3f94d.js"><link rel="prefetch" href="/assets/js/14.e1b9814b.js"><link rel="prefetch" href="/assets/js/15.fe1b5100.js"><link rel="prefetch" href="/assets/js/16.d147badc.js"><link rel="prefetch" href="/assets/js/17.b6bf6b8e.js"><link rel="prefetch" href="/assets/js/18.106ab12b.js"><link rel="prefetch" href="/assets/js/19.9dc7d0a2.js"><link rel="prefetch" href="/assets/js/20.e7085fe8.js"><link rel="prefetch" href="/assets/js/21.82911863.js"><link rel="prefetch" href="/assets/js/22.f46bb411.js"><link rel="prefetch" href="/assets/js/23.f1dc8101.js"><link rel="prefetch" href="/assets/js/25.7d1c55c4.js"><link rel="prefetch" href="/assets/js/26.f0bc4c51.js"><link rel="prefetch" href="/assets/js/27.ec545f01.js"><link rel="prefetch" href="/assets/js/28.fc678aa5.js"><link rel="prefetch" href="/assets/js/29.d3d2abd9.js"><link rel="prefetch" href="/assets/js/3.b10d7aa1.js"><link rel="prefetch" href="/assets/js/30.cb8ae1c3.js"><link rel="prefetch" href="/assets/js/31.bae2fa66.js"><link rel="prefetch" href="/assets/js/32.a34e5210.js"><link rel="prefetch" href="/assets/js/33.6c61b41f.js"><link rel="prefetch" href="/assets/js/34.22d3b341.js"><link rel="prefetch" href="/assets/js/35.5937a0a7.js"><link rel="prefetch" href="/assets/js/36.5bcbb7cf.js"><link rel="prefetch" href="/assets/js/37.62d46c8e.js"><link rel="prefetch" href="/assets/js/38.a598cd4c.js"><link rel="prefetch" href="/assets/js/4.ad227c3b.js"><link rel="prefetch" href="/assets/js/5.b8c308d4.js"><link rel="prefetch" href="/assets/js/6.962b3fa9.js"><link rel="prefetch" href="/assets/js/7.45f46359.js"><link rel="prefetch" href="/assets/js/8.5b174735.js"><link rel="prefetch" href="/assets/js/9.2c49762f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f1e15b89.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">LoRa 中文资料汇编</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/deltacat/lora-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/deltacat/lora-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/" class="sidebar-heading clickable router-link-active"><span>LoRaWAN 1.1 规范</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch01.html" class="sidebar-link">第1章 介绍</a></li><li><a href="/lorawan-v1.1/ch02.html" class="sidebar-link">第2章 LoRaWAN 选型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/CLASS-A" class="sidebar-heading clickable open"><span>CLASS A</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch03.html" class="sidebar-link">第3章 物理消息格式</a></li><li><a href="/lorawan-v1.1/ch04.html" aria-current="page" class="active sidebar-link">第4章 MAC 帧格式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-1-mac层" class="sidebar-link">4.1 MAC层</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-2-mac头" class="sidebar-link">4.2 MAC头</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-2-1-消息类型" class="sidebar-link">4.2.1 消息类型</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-2-2-数据消息的主版本" class="sidebar-link">4.2.2 数据消息的主版本</a></li></ul></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-3-数据消息的-mac-载荷" class="sidebar-link">4.3 数据消息的 MAC 载荷</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-3-1-帧头" class="sidebar-link">4.3.1 帧头</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-3-2-端口字段" class="sidebar-link">4.3.2 端口字段</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-3-3-mac帧载荷加密" class="sidebar-link">4.3.3 MAC帧载荷加密</a></li></ul></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-4-消息校验码" class="sidebar-link">4.4 消息校验码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-4-1-下行帧" class="sidebar-link">4.4.1 下行帧</a></li><li class="sidebar-sub-header"><a href="/lorawan-v1.1/ch04.html#_4-4-2-上行帧" class="sidebar-link">4.4.2 上行帧</a></li></ul></li></ul></li><li><a href="/lorawan-v1.1/ch05.html" class="sidebar-link">第5章 MAC 指令</a></li><li><a href="/lorawan-v1.1/ch06.html" class="sidebar-link">第6章 终端激活</a></li><li><a href="/lorawan-v1.1/ch07.html" class="sidebar-link">第7章 重传避让</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/CLASS-B" class="sidebar-heading clickable"><span>CLASS B</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch08.html" class="sidebar-link">第8章 Class B 介绍</a></li><li><a href="/lorawan-v1.1/ch09.html" class="sidebar-link">第9章 下行同步网络的原理</a></li><li><a href="/lorawan-v1.1/ch10.html" class="sidebar-link">第10章 Class B 模式的上行帧</a></li><li><a href="/lorawan-v1.1/ch11.html" class="sidebar-link">第11章 下行 Ping 帧格式（Class B选项）</a></li><li><a href="/lorawan-v1.1/ch12.html" class="sidebar-link">第12章 信标的获得和追踪</a></li><li><a href="/lorawan-v1.1/ch13.html" class="sidebar-link">第13章 Class B下行时隙时序</a></li><li><a href="/lorawan-v1.1/ch14.html" class="sidebar-link">第14章 Class B Mac命令</a></li><li><a href="/lorawan-v1.1/ch15.html" class="sidebar-link">第15章 信标（Class B选项)</a></li><li><a href="/lorawan-v1.1/ch16.html" class="sidebar-link">第16章 Class B 单播/多播下行信道频率</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/CLASS-C" class="sidebar-heading clickable"><span>CLASS C</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch17.html" class="sidebar-link">第17章 持续接收的终端</a></li><li><a href="/lorawan-v1.1/ch18.html" class="sidebar-link">第18章 Class C MAC 指令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/lorawan-v1.1/SUPPORT" class="sidebar-heading clickable"><span>SUPPORT INFORMATION</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/lorawan-v1.1/ch19.html" class="sidebar-link">19 Examples and Application Information</a></li><li><a href="/lorawan-v1.1/ch20.html" class="sidebar-link">20 Recommendation on contract to be provided to the Network Server by the end-device provider at the time of provisioning</a></li><li><a href="/lorawan-v1.1/ch21.html" class="sidebar-link">21 Recommendation on finding the locally used channels</a></li><li><a href="/lorawan-v1.1/ch22.html" class="sidebar-link">22 Revisions</a></li><li><a href="/lorawan-v1.1/ch23.html" class="sidebar-link">23 术语表</a></li><li><a href="/lorawan-v1.1/ch24.html" class="sidebar-link">24 Bibliography</a></li><li><a href="/lorawan-v1.1/ch25.html" class="sidebar-link">25 NOTICE OF USE AND DISCLOSURE</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/lorawan-v1.1/appendix" class="sidebar-heading clickable"><span>附录</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第4章-mac-帧格式"><a href="#第4章-mac-帧格式" class="header-anchor">#</a> 第4章 MAC 帧格式</h1> <p>所有 LoRa 上下行消息都会携带 PHY 载荷（<strong>Payload</strong>），PHY载荷以单一八位字节 MAC 头（<strong>MHDR</strong>）开始，紧接着 MAC 载荷（<strong>MACPayload</strong>）<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，最后是4字节的消息校验码（<strong>MIC</strong>）。</p> <ul><li>射频PHY层：</li></ul> <table class="lora-table"><tr><td>Preamble</td> <td>PHDR</td> <td>PHDR_CRC</td> <td bgcolor="silver">PHYPayload</td> <td>CRC</td></tr></table> <i class="lora-table-name">图5. 射频PHY结构（注意 CRC只有上行链路消息中存在）</i> <ul><li>PHY载荷：</li></ul> <table class="lora-table"><tr><td>MHDR</td> <td bgcolor="silver">MACPayload</td> <td>MIC</td></tr></table> <p>或</p> <table class="lora-table"><tr><td>MHDR</td> <td bgcolor="silver">Join-Request 或 Rejoin-Request</td> <td>MIC</td></tr></table> <p>或<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p> <table class="lora-table"><tr><td>MHDR</td> <td bgcolor="#CCCCCC">Join-Accept</td></tr></table> <i class="lora-table-name">图6. PHY载荷结构</i> <ul><li>MAC载荷：</li></ul> <table class="lora-table"><tr><td bgcolor="#CCCCCC">FHDR</td> <td>FPort</td> <td>FRMPayload</td></tr></table> <i class="lora-table-name">图7. MAC载荷结构</i> <ul><li>FHDR：</li></ul> <table class="lora-table"><tr><td>DevAddr</td> <td>FCtrl</td> <td>FCnt</td> <td>FOpts</td></tr></table> <i class="lora-table-name">图8. 帧头结构</i> <h2 id="_4-1-mac层"><a href="#_4-1-mac层" class="header-anchor">#</a> 4.1 MAC层</h2> <p>MAC 层（PHYPayload）</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>7..M</td> <td>4</td></tr> <tr><td><b>PHYPayload</b></td> <td>MHDR</td> <td>MACPayload</td> <td>MIC</td></tr></table> <i class="lora-table-name">图9. LoRa帧格式元素</i> <p>MACPayload字段的最大长度M，在第6章有详细说明。</p> <h2 id="_4-2-mac头"><a href="#_4-2-mac头" class="header-anchor">#</a> 4.2 MAC头</h2> <p>MAC 头（MHDR字段）</p> <table class="lora-table"><tr><td><b>Bit#</b></td> <td>7..5</td> <td>4..2</td> <td>1..0</td></tr> <tr><td><b>MHDR bits</b></td> <td>MType</td> <td>RFU</td> <td>Major</td></tr></table> <i class="lora-table-name">图10. MAC 头字段内容</i> <p>MAC 头中指定了消息类型（<em>MType</em>），以及根据 LoRaWAN 层规范中已经过编码的帧格式的主版本号（<em>Major</em>）。</p> <h3 id="_4-2-1-消息类型"><a href="#_4-2-1-消息类型" class="header-anchor">#</a> 4.2.1 消息类型</h3> <p>消息类型（MType 位字段）</p> <p>LoRaWAN 区分八种 MAC 消息类型：<strong>Join-request, Rejoin-request, Join-accept, unconfirmed data up/down, confirmed data up/down</strong>，以及 <strong>proprietary</strong> 协议消息。</p> <table class="lora-table"><tr><td><b>MType</b></td> <td><b>描述</b></td></tr> <tr><td>000</td> <td>Join Request</td></tr> <tr><td>001</td> <td>Join Accept</td></tr> <tr><td>010</td> <td>Unconfirmed Data Up</td></tr> <tr><td>011</td> <td>Unconfirmed Data Down</td></tr> <tr><td>100</td> <td>Confirmed Data Up</td></tr> <tr><td>101</td> <td>Confirmed Data Down</td></tr> <tr><td>110</td> <td>Rejoin-request</td></tr> <tr><td>111</td> <td>Proprietary</td></tr></table> <i class="lora-table-name">表1. MAC消息类型</i> <h4 id="_4-2-1-1-入网请求和接受消息"><a href="#_4-2-1-1-入网请求和接受消息" class="header-anchor">#</a> 4.2.1.1 入网请求和接受消息</h4> <p>join-request、Rejoin-request 和 join-accept 都是用在空中激活（OTAA）流程中，具体见章节6.2，以及用于漫游。</p> <h4 id="_4-2-1-2-数据消息"><a href="#_4-2-1-2-数据消息" class="header-anchor">#</a> 4.2.1.2 数据消息</h4> <p>Data messages 用来传输 MAC 指令数据和应用数据，这两种数据也可以合并在单个消息中发送。<strong>Confirmed-data message</strong> 接收者需要（MUST）应答，<strong>Unconfirmed-data message</strong> 接收者则不需要应答<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。 <strong>Proprietary messages</strong> 用来处理非标准的消息格式，不能和标准消息互通，只能用来和对于专有扩展具有共识的设备间进行通信。当终端设备或网络服务器收到未知的专有消息类型时，应当（SHALL）静默丢弃。</p> <p>消息完整性的保证根据消息类型所采用的方式不同，下面会具体介绍。</p> <h3 id="_4-2-2-数据消息的主版本"><a href="#_4-2-2-数据消息的主版本" class="header-anchor">#</a> 4.2.2 数据消息的主版本</h3> <p>主版本（Major 位字段）</p> <table class="lora-table"><tr><td><b>Major位字段</b></td> <td><b>描述</b></td></tr> <tr><td>00</td> <td>LoRaWAN R1</td></tr> <tr><td>01..11</td> <td>RFU</td></tr></table> <i class="lora-table-name">表2. Major 列表</i> <blockquote><p><strong>注意</strong>：主版本号定义了连接过程（join procedure，见章节6.2）和 MAC Payload 的前4字节（见第4章）使用的消息格式。终端可实现不同的次版本号消息格式。必须事先使用带外消息（即，作为设备个性化信息的一部分）使网络服务器知道终端设备使用的次要版本。当设备或网络服务器收到携带未知或不受支持的 LoRaWAN 版本的帧时，应当（SHALL）静默丢弃。</p></blockquote> <h2 id="_4-3-数据消息的-mac-载荷"><a href="#_4-3-数据消息的-mac-载荷" class="header-anchor">#</a> 4.3 数据消息的 MAC 载荷</h2> <p>数据消息的 MAC 载荷（MACPayload），包含一个帧头（<strong>FHDR</strong>）、可选的端口字段（<strong>FPort</strong>）以及可选的帧载荷（<strong>FRMPayload</strong>）。</p> <p>当一个帧具有有效 FHDR，但没有 Fopts（FoptsLen = 0）、Fport 和 FRMPayload，这样的帧也是有效帧。</p> <h3 id="_4-3-1-帧头"><a href="#_4-3-1-帧头" class="header-anchor">#</a> 4.3.1 帧头</h3> <p>帧头 <strong>FHDR</strong> 是包含终端短地址（<strong>DevAddr</strong>）、一个八位帧控制（FCtrl）字节、2字节帧计数器（<strong>FCnt</strong>）和最大 15 字节的帧选项（FOpts)用来传输 MAC 命令。FOpts 字段如果存在，应使用 NwkSEncKey 加密，如 4.3.1.6 节所述。</p> <table class="lora-table"><tr><td><b>Size(bytes)</b></td> <td>4</td> <td>1</td> <td>2</td> <td>0..15</td></tr> <tr><td><b>FHDR</b></td> <td>DevAddr</td> <td>FCtrl</td> <td>FCnt</td> <td>FOpts</td></tr></table> <i class="lora-table-name">图11. 帧头格式</i> <p>下行帧中，帧头的 FCtrl 内容如下：</p> <table class="lora-table"><tr><td><b>Bit#</b></td> <td>7</td> <td>6</td> <td>5</td> <td>4</td> <td>[3..0]</td></tr> <tr><td><b>FCtrl bits</b></td> <td>ADR</td> <td>RFU</td> <td>ACK</td> <td>FPending</td> <td>FOptsLen</td></tr></table> <i class="lora-table-name">图12. 下行 FCtrl 字段</i> <p>上行帧中，帧头的 FCtrl 内容如下：</p> <table class="lora-table"><tr><td><b>Bit#</b></td> <td>7</td> <td>6</td> <td>5</td> <td>4</td> <td>[3..0]</td></tr> <tr><td><b>FCtrl bits</b></td> <td>ADR</td> <td>ADRACKReq</td> <td>ACK</td> <td>ClassB</td> <td>FOptsLen</td></tr></table> <i class="lora-table-name">图13. 上行 FCtrl 字段</i> <h4 id="_4-3-1-1-帧头中自适应数据速率的控制"><a href="#_4-3-1-1-帧头中自适应数据速率的控制" class="header-anchor">#</a> 4.3.1.1 帧头中自适应数据速率的控制</h4> <p>（<strong>ADR, ADRACKReq in FCtrl</strong>）</p> <p>LoRa 网络允许终端采用任何可能的数据速率和发射功率。LoRaWAN 协议利用该特性来优化固定终端的数据速率。这就是自适应数据速率（Adaptive Data Rate，ADR）。当该特性启用时，网络会优化使用最快的数据速率。</p> <p>当无线电信道衰减快速且不断变化时，可能无法进行自适应数据速率控制。当网络服务器无法控制设备的数据速率时，设备的应用层应该控制它。 在这种情况下，建议使用各种不同的数据速率。应用层应该（SHOULD）总是尽量减少数据包的空中停留时间。</p> <p>如果上行 <strong>ADR</strong> 位有设置，网络就会通过相应的 MAC 命令来控制终端设备的数据速率和发射功率。如果 <strong>ADR</strong> 位没设置，网络则无视终端的接收信号强度，不再控制终端设备的数据速率。网络仍能（MAY）发送命令来改变频道掩码或帧重复参数。</p> <p>当下行链路 ADR 位有设置，它通知终端设备网络服务器将要发送 ADR 命令。设备可以（MAY）设置/取消上行链路 ADR 位。</p> <p>当下行链路ADR位未设置时，它向终端设备发信号通知由于无线电信道的快速变化，网络暂时无法估计最佳数据速率。在这种情况下，设备可以选择</p> <ul><li><p>将上行 ADR 置零，并按照自己的策略控制其上行链路数据速率。这应该（SHOULD）是移动终端设备的典型策略。</p></li> <li><p>忽略（保持上行链路 ADR 设置）并在没有 ADR 下行链路命令的情况下应用正常数据速率衰减。这应该（SHOULD）是固定式终端设备的典型策略。</p></li></ul> <p>ADR 位可以由终端设备或网络服务器按需设置或置零。但是，只要有可能，应该启用 ADR 方案以延长终端设备的电池寿命，并使网络容量最大化。</p> <blockquote><p><strong>注意</strong>：即使是移动的终端，可能在大部分时间也是处于非移动状态。因此根据它的移动状态，终端也可以请求网络使用上行ADR位来帮助优化数据速率。</p></blockquote> <p>默认发送功率是在考虑设备功能和区域监管限制时，设备允许的最大传输功率。设备应使用此功率水平，直到网络通过 LinkADRReq MAC 命令减小功率。</p> <p>如果终端被网络优化过的数据速率高于自己默认的数据速率，或者发送功率低于默认功率，它需要定期检查网络仍能收到上行帧。每次上行帧计数都会递增（是针对于每个新的上行包，重传包不增加计数），终端增加 ADR_ACK_CNT 计数。如在 ADR_ACK_LIMIT 次上行之后（ADR_ACK_CNT &gt;= ADR_ACK_LIMIT）都没有收到下行回复，它就得设置 ADR 应答请求位（<strong>ADRACKReq</strong>）。 网络需要在下面 ADR_ACK_CNT 个帧之内回复一个下行帧，上行之后收到任何下行帧就将计数器 ADR_ACK_CNT 重置。</p> <p>下行ACK位不需要设置，因为在终端设备的接收时隙期间的任何响应都表明网关仍然从该设备接收上行消息。</p> <p>如果在下一个 ADR_ACK_DELAY 上行时间内都没收到回复（即，在总时间ADR_ACK_LIMIT + ADR_ACK_DELAY之后），如果可能，终端必须（MUST）首先跳回默认功率，然后切换到下一个更低速率来获得更远无线距离来重连网络。</p> <p>终端如果在每次 ADR_ACK_DELAY 到了之后依旧连接不上，就要（MUST）逐步降低数据速率。一旦设备到达最低数据速率，那么就要（MUST）重新启用所有默认上行频道。</p> <p>如果终端用它的默认数据速率和发射功率，那就不要（SHALL）置位 <strong>ADRACKReq</strong>，因为这时无法帮助提高链路距离。</p> <blockquote><p>注意：不要求立即响应一个 ADR 应答请求给了网络一些灵活性来优化下行调度处理。</p></blockquote> <blockquote><p>注意：上行传输时在这些情况下要设置 <strong>ADRACKReq</strong>：如果 ADR_ACK_CNT &gt;= ADR_ACK_LIMIT 并且当前数据速率比设备的最小数据速率高，或者发射功率比默认功率低，或者当前信道掩码仅使用默认通道的子集。其他情况下清除它。</p></blockquote> <p>下表提供了数据速率补偿序列的示例，假设ADR_ACK_LIMIT 和 ADR_ACK_DELAY 常量均等于32。</p> <table class="lora-table"><tr><td><b>ADR_ACK_CNT</b></td> <td><b>ADRACKReq bit</b></td> <td><b>Data Rate</b></td> <td><b>TX power</b></td> <td><b>Channel Mask</b></td></tr> <tr><td>0 to 63</td> <td>0</td> <td>SF11</td> <td>Max – 9dBm</td> <td>Single channel enabled</td></tr> <tr><td>64 to 95</td> <td>1</td> <td>Keep</td> <td>Keep</td> <td>Keep</td></tr> <tr><td>96 to 127</td> <td>1</td> <td>Keep</td> <td><b>Max</b></td> <td>Keep</td></tr> <tr><td>128 to 159</td> <td>1</td> <td><b>SF12</b></td> <td>Max</td> <td>Keep</td></tr> <tr><td>&gt;= 160</td> <td>0</td> <td>SF12</td> <td>Max</td> <td><b>All channels enabled</b></td></tr></table> <i class="lora-table-name">图14. data rate back-off sequence example</i> <h4 id="_4-3-1-2-消息应答位及应答流程"><a href="#_4-3-1-2-消息应答位及应答流程" class="header-anchor">#</a> 4.3.1.2 消息应答位及应答流程</h4> <p>（<strong>ACK in FCtrl</strong>）</p> <p>收到 confirmed 类型的消息时，接收端要（SHALL）回复一条设置了应答位（ACK）的数据帧。如果发送者是终端设备，网络就利用终端发送操作后打开的两个接收窗口之一进行回复。如果发送者是网关，终端就自行决定是否发送应答（见下面的注释）。</p> <p>应答消息的发送只是为了回复收到的最后一条消息，并且永远不重发。</p> <blockquote><p><strong>注意</strong>：为了让终端尽可能简单，尽可能减少状态，在收到confirmation类型需要确认的数据帧，需要立即发送一个显式（也可能是空的）的应答数据帧。或者，终端会延迟发送应答，在它下一个数据帧中再携带。</p></blockquote> <h4 id="_4-3-1-3-重传流程"><a href="#_4-3-1-3-重传流程" class="header-anchor">#</a> 4.3.1.3 重传流程</h4> <p><strong>下行帧：</strong></p> <p>下行“confirmed”或“unconfirmed”帧不应（SHALL not）使用相同的帧计数器值重传。下行“confirmed”通讯中，如果没有接收到确认帧，则应用服务器可以决定重新发送新的“confirmed”帧。</p> <p><strong>上行帧：</strong></p> <p>上行“confirmed”和“unconfirmed”帧被发送“NbTrans”次（见5.3节），除非在其中一次传输之后接收到有效的下行消息。网络管理器可以使用“NbTrans”参数来控制节点上行链路的冗余，以获得给定的服务质量。终端设备在重复传输之间应像通常一样进行跳频，每次重复后应等待直到接收窗口过期。重新传输之间的延迟由终端设备决定，并且对于每个终端设备可能是不同的。</p> <p>如果接收到相应的下行链路确认帧，则设备应（SHALL）停止上行链路“confirmed”帧的重传。</p> <p>只要在 RX1 时隙窗口期间接收到有效的单播下行链路消息，Class B 和 C 的设备应（SHALL）停止上行链路“unconfirmed”帧的重传。</p> <p>每当在 RX1 或 RX2 时隙窗口期间接收到有效的下行链路消息时，Class A 设备应（SHALL）停止上行链路“unconfirmed”帧的重传。</p> <p>如果网络接收到多于 NbTrans 次相同上行链路帧，表明可能是重复攻击，或者可能设备故障，因此网络不应（SHALL not）处理这些帧。</p> <blockquote><p><strong>注意</strong>：检测到重复攻击的网络可以采取其他措施，例如将 NbTrans 参数减少为 1，或将原来信道接收的上行链路帧丢弃，这个信道已经传输了相同的帧，或者一些其他未指明的机制。</p></blockquote> <h4 id="_4-3-1-4-帧挂起位"><a href="#_4-3-1-4-帧挂起位" class="header-anchor">#</a> 4.3.1.4 帧挂起位</h4> <p>（<strong>FPending in FCtrl，只在下行有效</strong>）</p> <p>帧挂起位（<strong>FPending</strong>）只在下行通信中使用，表示网关还有下行数据等待下发，需要终端尽快发送上行消息来再打开一个接收窗口。</p> <p><strong>FPending</strong> 的详细用法在章节 19.3 说明。</p> <h4 id="_4-3-1-5-帧计数器"><a href="#_4-3-1-5-帧计数器" class="header-anchor">#</a> 4.3.1.5 帧计数器</h4> <p>（<strong>FCnt</strong>）</p> <p>每个终端有3个计数器跟踪数据帧的个数，一个是上行链路计数器（FCntUp），由终端在每次上行数据给网络服务器时累加；另一个是下行链路计数器（FCntDown），由服务器在每次下行数据给终端时累计。</p> <p>在下行链路方向上存在两种不同的帧计数器方案。单个计数器方案，其中所有端口在设备使用 LoRaWAN1.0 时共享相同的下行链路帧计数器 FCntDown。双计数器方案，在端口 0 和 FPort 字段缺失时，使用单独的 NFCntDown 进行 MAC 通信，当设备使用 LoRaWAN1.1 时，另一个AFCntDown 用于除端口 0 外的其他端口。</p> <p>双计数器方案中，NFCntDown 由网络服务器管理，而 AFCntDown 由应用服务器管理。</p> <blockquote><p><strong>注意</strong>：LoRaWAN v1.0 及更早版本仅支持一个 FCntDown 计数器（在所有端口之间共享），并且网络服务器必须注意支持 LoRaWAN v1.1 之前的设备。</p></blockquote> <p>每当 OTAA 设备成功处理 Join-accept 消息时，上行帧计数器（FCntUp）和下行帧计数器（NFCntDown 和 AFCntDown）将重置为0。</p> <p>ABP 入网的设备帧计数器在制造时初始化为 0。在ABP设备中，帧计数器不能（MUST NEVER）在设备的运行期间复位。如果终端设备在其运行期间容易断电（例如更换电池），则在这种情况下帧计数器应该（SHALL）持久化。</p> <p>之后 FCntUp 随每个上行链路递增，NFCntDown 随着每个下行链路递增（FPort 为 0 或 FPort 不存在）。AFCntDown随着每个下行链路递增（FPort 不为 0）。在接收侧，相应的计数器与接收的值保持同步，前提是接收的值与当前计数器值相比递增，并且消息 MIC 字段与利用网络会话密钥计算出的 MIC 匹配。在多次传输 confirmed 或 unconfirmed 的帧的情况下，FCnt不会递增（请参阅NbTrans参数）。网络服务器应（SHALL）删除重复传输的帧，并仅将单个实例转发到应用程序服务器。</p> <p>帧计数器是32位宽，<strong>FCnt</strong> 字段对应于32位帧计数器的最低有效16位（例，用于发送上行链路的数据帧的 FCntUp 和用于下行链路发送的数据帧的 AFCntDown / NFCntDown）。</p> <p>终端设备不应（SHALL NEVER）在相同应用重复使用相同的 FCntUp 值或网络会话密钥，除了重传相同的 confirmed 或 unconfirmed 的帧。</p> <p>终端设备应该（SHALL）永远不会处理相同下行链路帧的任何重传。重传的帧应忽略，不做任何处理。</p> <blockquote><p><strong>注意</strong>：这意味着一旦接收到下行链路 confirmed 帧，设备将仅回复消息（ACK），类似地，设备将仅在接收到设置了 FPending 位的帧之后生成单个上行链路消息。</p> <p><strong>注意</strong>：由于 FCnt 字段仅携带 32 位帧计数器的最低有效 16 位，因此服务器必须从通信状况推断出帧计数器的16个最高有效位。</p></blockquote> <h4 id="_4-3-1-6-帧选项"><a href="#_4-3-1-6-帧选项" class="header-anchor">#</a> 4.3.1.6 帧选项</h4> <p>（<strong>FOptsLen in FCtrl, FOpts</strong>）</p> <p>FCtrl 字节中的 <strong>FOptsLen</strong> 位字段描述了整个帧选项（<strong>FOpts</strong>）的字段长度。</p> <p><strong>FOpts</strong> 字段传送背负于数据帧的最大 15 字节 MAC 命令，第 5 章列出有效 MAC 指令。</p> <p>如果 <strong>FOptsLen</strong> 为 0，<strong>FOpts</strong> 为空。<strong>在 FOptsLen</strong> 非 0 时，比如 MAC 命令在 <strong>FOpts</strong> 字段中体现，port 0 不能使用（<strong>FPort</strong> 要么不存在，要么非0）。</p> <p>MAC 命令不能同时出现在 FRMPayload 和 FOpts 中，如果出现这种情况，设备将（SHALL）丢弃该组数据。</p> <p>如果帧头部携带 <strong>FOpts</strong>，则必须（MUST）在计算消息完整性代码（MIC）之前对 <strong>FOpts</strong> 进行加密。</p> <p>所使用的加密方案基于 IEEE 802.15.4/2006 Annex B [IEEE802154-DOC] 中描述的通用算法，其使用密钥长度为128位的AES。</p> <p>使用的密钥 <em>K</em> 是上行和下行方向上的 FOpts 字段的 NwkSEncKey。</p> <p>加密的字段是：pld = FOpts</p> <p>对于每条消息，算法定义一个数据块 <em><strong>A</strong></em>：</p> <table class="lora-table"><tr><td><b>Size(bytes)</b></td> <td>1</td> <td>4</td> <td>1</td> <td>4</td> <td>4</td> <td>1</td> <td>1</td></tr> <tr><td><b><i>A</i></b></td> <td>0x01</td> <td>4 x 0x00</td> <td>Dir</td> <td>DevAddr</td> <td>FCntUp or NFCntDwn</td> <td>0x00</td> <td>0x00</td></tr></table> <i class="lora-table-name">图15. 加密块格式</i> <p>方向字段（<strong>Dir</strong>）当上行链路帧为0，当下行链路帧为1。</p> <p>数据块 <em>A</em> 被加密以获得数据块 <em>S</em>：</p> <p></p><p><mjx-container jax="SVG" display="true" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="26.1ex" height="2.262ex" viewBox="0 -750 11536.2 1000" style="vertical-align:-0.566ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(890.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(1946.6, 0)"><path data-c="61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(2475.6, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(2941.6, 0)"><path data-c="73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mn" transform="translate(3410.6, 0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500, 0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(1000, 0)"></path></g><g data-mml-node="mi" transform="translate(4910.6, 0)"><path data-c="5F" d="M0 -62V-25H499V-62H0Z"></path></g><g data-mml-node="mi" transform="translate(5410.6, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(5876.6, 0)"><path data-c="6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(6476.6, 0)"><path data-c="63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(6909.6, 0)"><path data-c="72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(7360.6, 0)"><path data-c="79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(7850.6, 0)"><path data-c="70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(8353.6, 0)"><path data-c="74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mo" transform="translate(8714.6, 0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(9103.6, 0)"><path data-c="4B" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mo" transform="translate(9952.6, 0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(10397.2, 0)"><path data-c="41" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mo" transform="translate(11147.2, 0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></p><p></p> <p>通过将 (pld | pad_16) xor S 截断到第一个len(<em>pld</em>) 八位字节来完成 FOpts 的加密和解密。</p> <h3 id="_4-3-2-端口字段"><a href="#_4-3-2-端口字段" class="header-anchor">#</a> 4.3.2 端口字段</h3> <p>（<strong>FPort</strong>）</p> <p>如果帧载荷字段不为空，端口字段必须（MUST）体现出来。端口字段有体现时，若 <strong>FPort</strong> 的值为 0 表示 <strong>FRMPayload</strong> 只包含了MAC命令，接受到的任何具有这种 FPort 的帧都应由 LoRaWAN 实现处理，具体见第 5 章中的 MAC 命令。FPort 的值从 1 到 223(0x01..0xDF) 都是由应用层使用。FPort 值 224 专用于 LoRaWAN MAC 层测试协议。 LoRaWAN 实现应该丢弃 FPort 值不在 1..224 范围内的应用层的任何传输请求。</p> <blockquote><p><strong>注意</strong>：FPort 值 224 的目的是提供专用的 FPort，以便在最终版本的设备上通过无线方式运行MAC一致性测试场景，而无需在实际方面依赖于设备的特定测试版本。该测试不应与实时操作同时进行，但设备的MAC层实现应完全是可正常的使用。通常使用 AppSKey 加密测试协议。这可确保网络服务器不能在没有设备所有者参与的情况下启用设备的测试模式。如果测试在实时网络连接设备上运行，则网络侧测试应用程序学习AppSKey的方式不在LoRaWAN规范的范围。如果测试在专用测试平台（不是实时网络）上使用OTAA运行，则 AppKey 与测试平台通信的方式，对于安全的 JOIN 过程，也不在规范范围内。</p> <p>在应用层运行的测试协议是在LoRaWAN规范之外定义的，因为它是一个应用层协议。</p></blockquote> <p>FPort 值 225..255（0xE1..0xFF）保留用于将来的标准化应用程序扩展。</p> <table class="lora-table"><tr><td><b>Size(bytes)</b></td> <td>7..22</td> <td>0..1</td> <td>0..N</td></tr> <tr><td><b>MACPayload</b></td> <td>FHDR</td> <td>FPort</td> <td>FRMPayload</td></tr></table> <i class="lora-table-name">图16. MACPayload field size</i> <p><em>N</em> 是应用程序载荷的字节个数。<em>N</em> 的有效范围具体在 [PHY-DOC] 定义。</p> <p><em>N</em> 应该（MUST）小于等于：</p> <p>N ≤ M - 1 - (FHDR长度)</p> <p><em>M</em> 是 MAC 载荷的最大长度。</p> <h3 id="_4-3-3-mac帧载荷加密"><a href="#_4-3-3-mac帧载荷加密" class="header-anchor">#</a> 4.3.3 MAC帧载荷加密</h3> <p>如果数据帧携带了载荷，FRMPayload 必须要在 MIC 计算前进行加密。</p> <p>加密机制是采用 IEEE 802.15.4/2006 Annex B [IEEE802154-DOC] 的 AES128 算法。</p> <p>使用的密钥 <em>K</em> 取决于数据消息的 FPort：</p> <table class="lora-table"><tr><td><b>FPort</b></td> <td><b>Direction</b></td> <td><b>K</b></td></tr> <tr><td>0</td> <td>Uplink/downlink</td> <td>NwkSEncKey</td></tr> <tr><td>1..255</td> <td>Uplink/downlink</td> <td>AppSKey</td></tr></table> <i class="lora-table-name">表3. FPort列表</i> <p>加密的字段是：</p> <p><em>pld</em> = <strong>FRMPayload</strong></p> <p>对于每个数据帧，算法定义了一个块序列 <em>A_i</em>，i 从 1 到 k，k = ceil(len(<em>pld</em>) / 16)：</p> <table class="lora-table"><tr><td><b>Size(bytes)</b></td> <td>1</td> <td>4</td> <td>1</td> <td>4</td> <td>4</td> <td>1</td> <td>1</td></tr> <tr><td><b><i>A<sub>i</sub></i></b></td> <td>0x01</td> <td>4 x 0x00</td> <td>Dir</td> <td>DevAddr</td> <td>FCntUp or NFCntDwn or AFCntDnw</td> <td>0x00</td> <td>i</td></tr></table> <p>方向字段(<strong>Dir</strong>)在上行帧时为0，在下行帧时为1.
块 <em>A<sub>i</sub></em> 通过加密，得到一个由块 <em>S<sub>i</sub></em> 组成的序列 <em>S</em>。</p> <p><em>S<sub>i</sub></em> = aes128_encrypt(K, <em>A<sub>i</sub></em>) for i = 1..k
S = <em>S1 | S2 | .. | S<sub>k</sub></em></p> <p>有效载荷的加密和解密通过截断来完成</p> <p>(<em>pld</em> | pad<sub>16</sub>）xor S.</p> <p>到第一个 len(<em>pld</em>) 八位字节。</p> <h2 id="_4-4-消息校验码"><a href="#_4-4-消息校验码" class="header-anchor">#</a> 4.4 消息校验码</h2> <p>消息检验码（MIC）要计算消息中所有字段。</p> <p><em>msg</em> = <strong>MHDR | FHDR | FPort | FRMPayload</strong></p> <p>其中 len（msg）表示以八位字节为单位的消息长度。</p> <h3 id="_4-4-1-下行帧"><a href="#_4-4-1-下行帧" class="header-anchor">#</a> 4.4.1 下行帧</h3> <p>下行链路帧的MIC计算如下 [RFC4493-DOC]：</p> <p><em>cmac</em> = aes128_cmac(S<strong>NwkSIntKey</strong>, <em>B<sub>0</sub></em> | msg)
<strong>MIC</strong> = <em>cmac</em>[0..3]</p> <p>数据块 <em>B<sub>0</sub></em> 的定义如下：</p> <table class="lora-table"><tr><td><b>Size<br>(bytes)</b></td> <td>1</td> <td>2</td> <td>2</td> <td>1</td> <td>4</td> <td>4</td> <td>1</td> <td>1</td></tr> <tr><td><b><i>B<sub>0</sub></i></b></td> <td>0x49</td> <td>ConfFCnt</td> <td>2 x 0x00</td> <td>Dir=0x01</td> <td>DevAddr</td> <td>AFCntDwn or NFCntDwn</td> <td>0x00</td> <td>len(<i>msg</i>)</td></tr></table> <i class="lora-table-name">图18. 下行 MIC 计算块格式</i> <p>如果设备连接到 LoRaWAN1.1 网络服务器并且下行帧的 ACK 位被设置，意味着该帧确认上行“confirmed”帧，则 ConfFCnt 是正在应答的这个上行“confirmed”帧的帧计数器对 2^16 取模。在所有其他情况下，ConfFCnt = 0x0000。</p> <h3 id="_4-4-2-上行帧"><a href="#_4-4-2-上行帧" class="header-anchor">#</a> 4.4.2 上行帧</h3> <p>上行帧的 MIC 通过以下过程计算：</p> <p>数据块 <em>B<sub>0</sub></em> 的定义如下：</p> <table class="lora-table"><tr><td><b>Size(bytes)</b></td> <td>1</td> <td>4</td> <td>1</td> <td>4</td> <td>4</td> <td>1</td> <td>1</td></tr> <tr><td><b><i>B<sub>0</sub></i></b></td> <td>0x49</td> <td>0x0000</td> <td>Dir = 0x00</td> <td>DevAddr</td> <td>FCntUp</td> <td>0x00</td> <td>len(<i>msg</i>)</td></tr></table> <i class="lora-table-name">图19. uplink B0 MIC computation block format</i> <p>数据块 <em>B<sub>1</sub></em> 的定义如下：</p> <table class="lora-table"><tr><td><b>Size (bytes)</b></td> <td>1</td> <td>2</td> <td>1</td> <td>1</td> <td>1</td> <td>4</td> <td>4</td> <td>1</td> <td>1</td></tr> <tr><td><b><i>B<sub>1</sub></i></b></td> <td>0x49</td> <td>ConfFCnt</td> <td>TxDr</td> <td>TxCh</td> <td>Dir = 0x00</td> <td>DevAddr</td> <td>FCntUp</td> <td>0x00</td> <td>len(<i>msg</i>)</td></tr></table> <i class="lora-table-name">图20. uplink B1 MIC computation block format</i> <p>其中：</p> <ul><li>TxDr 是用于传输上行链路的数据速率。</li> <li>TxCh 是用于传输的信道的索引值。</li> <li>如果设置了上行链路帧的 ACK 位，意味着该帧正在确认下行链路 “confirmed” 帧，这时  ConfFCnt 是正应答的该下行 “confirmed” 帧的帧计数器对 2^16 取模。在所有其他情况下，ConfFCnt = 0x0000。</li></ul> <p><em>cmacS</em> = aes128_cmac(S<strong>NwkSIntKey</strong>, <em>B<sub>1</sub></em> | <em>msg</em>)</p> <p><em>cmacF</em> = aes128_cmac(F<strong>NwkSIntKey</strong>, <em>B<sub>0</sub></em> | <em>msg</em>)</p> <p>如果设备连接到LoRaWAN1.0网络服务器，则：</p> <p>MIC = <em>cmacF</em>[0..3]</p> <p>如果设备连接到LoRaWAN1.1网络服务器，则：</p> <p>MIC = <em>cmacS</em>[0..1] | <em>cmacF</em>[0..1]</p> <hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>最大有效载荷的长度详见第6章。 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li> <li id="fn2" class="footnote-item"><p>对于Join-Accept帧，MIC字段使用有效载荷加密，而不是单独的字段. <a href="#fnref2" class="footnote-backref">↩︎</a></p></li> <li id="fn3" class="footnote-item"><p>第19章给出了确认机制的详细时序图。 <a href="#fnref3" class="footnote-backref">↩︎</a></p></li></ol></section></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/deltacat/lora-docs/edit/master/docs/lorawan-v1.1/ch04.md" target="_blank" rel="noopener noreferrer">帮我改善此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">9/22/2019, 8:19:28 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lorawan-v1.1/ch03.html" class="prev">
        第3章 物理消息格式
      </a></span> <span class="next"><a href="/lorawan-v1.1/ch05.html">
        第5章 MAC 指令
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.741f693f.js" defer></script><script src="/assets/js/2.1bc0aca8.js" defer></script><script src="/assets/js/24.b81b8f52.js" defer></script>
  </body>
</html>
