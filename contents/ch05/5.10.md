### 5.10 秘钥更新指示命令（Rekey indication commands，***RekeyInd***，***RekeyConf***)

此 MAC 指令仅适用于在兼容 LoRaWAN1.1 的网络服务器上激活的 OTA 设备。LoRaWAN1.0 服务器没有实现这个 MAC 指令。

ABP 设备不（MUST NOT）实现指令。网络服务器应该忽略来自 ABP 设备的 ***RekeyInd*** 指令。

对于 OTA 设备，***RekeyInd*** 指令用于确认安全密钥更新，在未来的协议版本（>1.1）中，还将用于协商在终端设备和网络服务器之间运行的LoRaWAN协议次版本号。该命令不发出重置MAC & radio 参数的信号（参见 6.2.3）。

***RekeyInd*** 指令包含终端设备支持的 LoRaWAN 协议次版本号.

<table class="lora-table">
   <tr>
      <td><b>Size (bytes)</b></td>   
      <td>1</td>   
   </tr>
   <tr>
      <td><b>RekeyInd Payload</b></td>
      <td>Dev LoRaWAN version</td>
   </tr>
</table>   

*图 36 : RekeyInd payload format*

<table class="lora-table">
   <tr>
      <td><b>Size (bytes)</b></td>   
      <td>7:4</td>   
      <td>3:0</td>   
   </tr>
   <tr>
      <td><b>Dev LoRaWAN version</b></td>
      <td>RFU</td>
      <td>Minor=1</td>
   </tr>
</table>   

Minor 字段表示终端设备支持的 LoRaWAN 版本的次版本号。

<table class="lora-table">
   <tr>
      <td><b>Minor version</b></td>   
      <td><b>Minor</b></td>   
   </tr>
   <tr>
      <td>RFU</td>
      <td>0</td>
   </tr>
   <tr>
      <td>1 (LoRaWAN x.1)</td>
      <td>1</td>
   </tr>
   <tr>
      <td>RFU</td>
      <td>2:15</td>
   </tr>
</table>   

OTA 设备应在（SHALL）成功处理 Join-accept 会话之后（派生了新的会话密钥），在所有已确认和未确认上行帧中发送 ***RekeyInd***，直到接收到 ***RekeyConf*** 为止。如果设备在第一个 ADR_ACK_LIMIT 上行通信中没有收到 ***RekeyConf***，那么它将恢复到 Join 状态。在以后的任何时候，这些设备发送的 ***RekeyInd*** 命令都将（SHALL）被网络服务器丢弃。网络服务器应（SHALL）丢弃任何受新安全上下文保护的上行帧，这些上行帧在**Join-accept** 传输之后以及携带 ***RekeyInd*** 命令的第一个上行帧之前接收。

当网络服务器接收到 ***RekeyInd*** 指令，就以一个 ***RekeyConf*** 指令应答。

***RekeyConf*** 指令包含一个单字节载荷，该载荷编码网络服务器支持的 LoRaWAN 版本，使用与“dev LoRaWan version”相同的格式。

<table class="lora-table">
   <tr>
      <td><b>Size (bytes)</b></td>   
      <td>1</td>   
   </tr>
   <tr>
      <td><b>RekeyConf Payload</b></td>
      <td>Serv LoRaWAN version</td>
   </tr>
</table>   

*图 37 : RekeyConf payload format*

服务器版本必须大于0(不允许为0)，小于或等于设备的LoRaWAN版本(<=)。因此，对于LoRaWAN1.1 设备，惟一的有效值是 1。如果服务器的版本无效，设备将丢弃 ***RekeyConf*** 命令，并在下一个上行帧中重新传输 ***RekeyInd***。

