


## **第3章 PHY 帧格式**

LoRa 有上行消息和下行消息。

### <a name="3.1">3.1 上行消息</a>

上行消息是由终端发出，经过一个或多个网关转发给网络服务器。

上行消息使用 LoRa 射频帧的显式模式[^1]，消息中含有 PHDR 和 PHDR_CRC 。载荷由CRC校验来保证完整性。

PHDR，PHDR_CRC 及载荷 CRC 字段都通过射频收发器(例如SX1278)加入。  

上行消息物理层结构:
<table>
   <tr>
      <td>Preamble</td>
      <td>PHDR</td>
      <td>PHDR_CRC</td>
      <td>PHYPayload</td>
      <td>CRC</td>
   </tr>
</table>

图2.上行PHY帧格式  

### <a name="3.2">3.2 下行消息</a>

下行消息是由网络服务器发出，经过单个网关转发给单个终端[^2]。

下行消息使用射频帧的严格模式，消息中包含 PHDR 和 PHDR_CRC[^3]。

下行消息物理层结构:
<table>
   <tr>
      <td>Preamble</td>
      <td>PHDR</td>
      <td>PHDR_CRC</td>
      <td>PHYPayload</td>
   </tr>
</table>

图3.下行PHY帧格式

> 注：
[^1] 有关LoRa无线电数据包隐式/显式模式的说明，请参阅LoRa射频收发器数据表。
[^2] 本规范未描述从网络服务器向多个终端设备传输多播消息的情况。
[^3] 此级别不进行有效载荷完整性检查，以使消息尽可能短，对所使用的ISM频段的占空比限制的影响最小。

### <a name="3.3">3.3 接收窗口</a>

每个上行传输后终端都要开两个短的接收窗口。接收窗口开始时间的规定，是以传输结束时间为参考。

![](/media/lorawan_ed_receive_slot_timing.png)

图4.终端接收时隙的时序图

#### <a name="3.3.1">3.3.1 第一接收窗口的信道，数据速率和启动</a>

第一接收窗口 RX1 使用的频率和上行频率有关，使用的速率和上行速率有关。RX1 是在上行调制结束后的 RECEIVE_DELAY1[^1]秒（+/- 20微秒）打开。上行和 RX1 时隙下行速率的关系是按区域规定，详细描述在[LoRaWAN地区参数]文件中。默认第一窗口的速率是和最后一次上行的速率相同。

#### <a name="3.3.2">3.3.2 第二接收窗口的信道，数据速率和启动</a>

第二接收窗口 RX2 使用一个固定可配置的频率和数据速率，在上行调制结束后的 RECEIVE_DELAY2[^1]秒（+/- 20微秒）打开。频率和数据速率可以通过 MAC 命令(见 第5章)。默认的频率和速率是按区域规定，详细描述在[LoRaWAN地区参数]文件中。

> 注：
[^1] RECEIVE_DELAY1 和 RECEIVE_DELAY2 的描述见第6章

#### <a name="3.3.3">3.3.3 接收窗口的持续时间</a>

接收窗口的长度至少要让终端射频收发器有足够的时间来检测到下行的前导码。

#### <a name="3.3.4">3.3.4 接收方在接收窗口期间的处理</a>

如果在任何一个接收窗口中检测到前导码，射频接收器需要继续工作，直到整个下行帧都解调完毕。如果在第一接收窗口检测到数据帧，且这个数据帧的地址和MIC校验通过确认是给这个终端，那终端就不必开启第二个接收窗口。

#### <a name="3.3.5">3.3.5 网络发送消息给终端</a>

如果网络打算将下行消息发送到终端设备，它必须至少在其中一个接收窗口的起始时间点精确地开始传输。如果在两个窗口开启期间都发送下行消息，则必须在每个窗口发送相同的帧。

#### <a name="3.3.6">3.3.6 接收窗口的重要事项</a>

终端设备在第一或第二接收窗口中收完下行消息后，或者在第二接收窗口失效之后(第一或第二窗口均未收到下行消息)，才能再发起另一个上行消息。

#### <a name="3.3.7">3.3.7 其他协议的收发处理</a>

节点在LoRaWAN传输和接收窗口之间可以收发其他协议或进行任何无线电通信交互，只要终端能满足当地要求以及兼容LoRaWAN协议。

