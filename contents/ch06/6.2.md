### 6.2 空中激活 OTAA

对于空中激活，终端设备在与网络服务器进行数据交换之前必须执行连接过程。终端设备每次丢失会话上下文信息时都必须执行一个新的连接过程。

如上所述，连接过程要求终端设备在开始连接之前使用以下信息进行个性化处理：DevEUI、JoinEUI、NwkKey 和 AppKey。

>注意：对于空中激活，终端设备不使用一对网络会话密钥进行个性化。相反，每当终端设备加入网络时，特定于该终端设备的网络会话密钥才会被派生出来以加密和验证网络级别上的传输。这样，终端设备在不同提供者的网络之间漫游更加便利。使用不同的网络会话密钥和应用程序会话密钥进一步允许联盟网络服务器中应用程序数据不能被网络提供者读取。

#### 6.2.1 连接过程

从终端设备视角来看，连接过程由一对 MAC 指令的交互组成， **Join** 或 **Rejoin-Request**，和  **Join-Accept**。

#### 6.2.2 Join-request message

连接过程总是从终端设备通过发送 Join-Request 消息发起。

<table class="lora-table">
   <tr>
      <td><b>Size (bytes)</b></td>
      <td>8</td>
      <td>8</td>
	  <td>2</td>
   </tr>
   <tr>
      <td><b>Join Request</b></td>
      <td>JoinEUI</td>
      <td>DevEUI</td>
	  <td>DevNonce</td>
   </tr>
</table>

*Figure 44 : Join-request message fields*

Join-Request 消息包含终端设备的 **JoinEUI** 和 **DevEUI**，后面跟着一个由 2 个八位元构成的 nonce（**DevNonce**）

**DevNonce** 是一个当设备最初上电从 0 开始的计数器，并随着每个 Join-Request 递增。对于给定的 JoinEUI 值，不能（SHALL NEVER）重复使用 DevNonce。如果终端设备可以进行电源循环，那么 DevNonce 应该（SHALL）是持久化的（存储在非易失性内存中）。在不更改 JoinEUI 的情况下重置 DevNonce 将导致网络服务器丢弃设备的连接请求。对于每个终端设备，网络服务器跟踪该设备使用的最后一个 DevNonce 值，如果不增加 DevNonce，则忽略连接请求。

>注意：该机制防范试图通过发送先前记录的 Join-Request 消息将相应设备与网络断开的重播攻击。任何时候网络服务器处理一个 Join-Request 并生成一个 Join-Accept 帧时，应当（SHALL）同时维护新旧安全上下文（秘钥和计数器，如果有的话），直到它接收到第一个成功的包含使用新的上下文的 ***RekeyInd*** 指令的上行帧，旧的上下文可以安全地删除。

Join-Request 消息的完整性代码 MIC 值（MAC 消息描述参阅第 4 章）计算如下：[^注1]

- *cmac* = aes128_cmac(NwkKey, MHDR | JoinEUI | DevEUI | DevNonce)
- MIC = *cmac*[0..3]

Join-Request 消息不做加密。Join-Request 消息可以使用任意的数据速率，并遵循指定连接通道上的随机跳频序列进行传输。建议（RECOMMENDED）使用多个数据速率。**Join-Request** 之间的传输间隔应符合第 7 章中描述的条件。对于 **Join-Request** 的每次传输，终端设备应（SHALL）增加 DevNonce 值。

#### 6.2.3 Join-accept message

如果允许终端设备加入网络，网络服务器将使用 **Join-Accept** 消息响应 **Join** 或 **Rejoin-Request** 消息。消息如同像普通下行通讯一样发送，但是使用 JOIN_ACCEPT_DELAY1 或 JOIN_ACCEPT_DELAY2 延迟（而不是 RECEIVE_DELAY1 和 RECEIVE_DELAY2）。用于这两个接收窗口的通道频率和数据速率与在 [PHY-DOC] “接收窗口”一节中描述的用于 RX1 和 RX2 接收窗口的通道频率和数据速率相同。

如果加入请求不被接受，则不会向终端设备提供响应。

Join-accept 消息包含一个服务器 nonce（**JoinNonce**，3个八位字节），一个网络标识符（**NetID**），一个终端设备地址（**DevAddr**），一个（**DLSettings**）字段提供一些下行参数、TX 和 RX 之间的延迟（**RxDelay**）和网络终端设备连接的网络的可选的网络参数列表（**CFList**）。可选 CFList 字段是特定于区域的，在 [PHY-DOC] 中定义。

![](/media/15663886319732.jpg)

*Figure 45 : Join-accept message fields*

**JoinNonce** 是连接服务器提供的特定于设备的计数器值（从不重复），终端设备使用它派生会话密钥 **FNwkSIntKey**、**SNwkSIntKey**、**NwkSEncKey** 和 **AppSKey**。JoinNonce 随每个Join-accept 消息递增。

设备跟踪最后一个成功处理的 Join-accept 中使用的 JoinNonce 值（对应于最后一个成功的密钥派生）。设备应（SHALL）仅接受 MIC 字段正确 JoinNonce 严格大于所记录的值的 Join-Accept。这时，新的 JoinNonce 值将替换之前存储的值。

如果设备容易受到电源循环的影响，则 JoinNonce 应该是持久化的（存储在非易失性内存中）。

LoRa 联盟为所有网络分配了一个 24 位的唯一网络标识符（NetID），以下 NetID 值除外，它们保留给未受管理的实验性或私有网络。

有 2^15 个私有/实验网络保留的 NetID 值，构建如下:

![](/media/15663881581574.jpg)

Join-accept 帧的 home_NetID 字段对应于设备的宿主网络的 NetId。

在漫游场景中，分配 devAddr 的网络和宿主网络可能不同。如需更准确的数据，请参考 [BACKEND-DOC]。

DLsettings 字段包含下行配置:

![](/media/15663881239486.jpg)

OptNeg 标志位位指示网络服务器实现了 LoRaWAN1.0 协议版本（未设置）还是 1.1 和更新的版本（设置）。当 OptNeg 标志位是设置的状态时：

- 协议版本在终端设备和网络服务器之间通过 ***RekeyInd/RekeyConf*** MAC 指令交互进行进一步协商（1.1或更高版本）
- 设备从NwkKey 派生出 **FNwkSIntKey** & **SNwkSIntKey** & **NwkSEncKey**
- 设备从 **AppKey** 派生 **AppSKey**

当 OptNeg 标志位没有设置时：

* 设备恢复为 LoRaWAN1.0，没有可协商选项
* ***RekeyInd*** 命令不由设备发送
* 设备从 NwkKey 派生出**FNwkSIntKey** 和 **AppSKey**
* 设备将 **SNwkSIntKey** 和 **NwkSEncKey** 设置为 **FNwkSIntKey**

4 个会话密钥 **FNwkSIntKey**，**SNwkSIntKey**，**NwkSEncKey** 和 **AppSKey** 派生如下:

如果 OptNeg 未设置，则会话密钥从 NwkKey 派生如下:

- AppSKey = aes128_encrypt(NwkKey, 0x02 | JoinNonce | NetID | DevNonce | pad<sub>16</sub> [^注2])
- FNwkSIntKey = aes128_encrypt(NwkKey, 0x01 | JoinNonce | NetID | DevNonce | pad<sub>16</sub>)
- SNwkSIntKey = NwkSEncKey = FNwkSIntKey.

Join-Accept 消息的 MIC 值计算如下：[^注3]

- *cmac* = aes128_cmac(**NwkKey**, MHDR | JoinNonce | NetID | DevAddr | DLSettings | RxDelay | CFList )
- MIC = *cmac*[0..3]

否则如果 OptNeg 有置位，AppSKey 以如下方式从 AppKey 派生：

- AppSKey = aes128_encrypt(AppKey, 0x02 | JoinNonce | JoinEUI | DevNonce | pad<sub>16</sub>)

网络会话秘钥从 NwkKey 派生：

- FNwkSIntKey = aes128_encrypt(NwkKey, 0x01 | JoinNonce | JoinEUI | DevNonce | pad<sub>16</sub>)
- SNwkSIntKey = aes128_encrypt(NwkKey, 0x03 | JoinNonce | JoinEUI | DevNonce | pad<sub>16</sub>)
- NwkSEncKey = aes128_encrypt(NwkKey, 0x04 | JoinNonce | JoinEUI | DevNonce | pad<sub>16</sub>)

这种情况 MIC 值这样计算：[^注4]

- *cmac* = aes128_cmac(**JSIntKey**, JoinReqType | JoinEUI | DevNonce | MHDR | JoinNonce | NetID | DevAddr | DLSettings | RxDelay | CFList )
- MIC = *cmac*[0..3]

JoinReqType 是一个单字节字段，编码触发 Join-accept 响应的 Join-request 或 Rejoin-request 的类型。

![](/media/15663882703364.jpg)
*Table 13 : JoinReqType values*

用于加密 Join-Accept 消息的密钥是触发该消息的 Join 或 ReJoin-Request 消息的功能。

![](/media/15663882942319.jpg)

*Table 14: Join-Accept encryption key*

Join-Accept 消息以如下方式加密：

- aes128_decrypt(**NwkKey** or **JSEncKey**, JoinNonce | NetID | DevAddr | DLSettings | RxDelay | CFList | MIC)

该消息长度为 16 或 32 字节。

>注意：ECB 模式下的 AES 解密操作用于加密 Join-Accept 消息，以便终端设备可以使用 AES 加密操作解密消息。这样，终端设备只需要实现AES加密，而不需要AES解密。
>注意：建立这四个会话密钥允许网络服务器联盟基础设施，其中网络运营商不能窃听应用程序数据。应用程序提供者向网络运营商承诺，它将承担终端设备产生的任何流量的费用，并保留对用于保护其应用程序数据的 **AppSKey** 的完全控制。
>注意：设备的协议版本（1.0或1.1）与 DevEUI 和设备的 NwkKey，可能还有AppKey，同时在带外后端注册

RX1DRoffset 字段设置上行数据速率与用在第一个接收槽（RX1）上与终端设备通信的下行数据速率之间的偏移量。默认情况下，这个偏移量为0。偏移量用于应对某些地区基站的最大功率密度限制，并平衡上下行无线电链路的裕度。

上下行数据速率之间的实际关系是特定于区域的，并在 [PHY-DOC] 中详细说明。

延迟 **RxDelay** 遵循与 ***RXTimingSetupReq*** 命令中的 **Delay** 字段相同的约定。

如果 Join-Accept 消息在以下传输之后接收到的:

- Join-Request 或 Rejoin-request 类型 0 或 1，并且如果缺少 CFlist 字段，则设备应（SHALL）恢复到其默认通道定义。如果 CFlist 存在，它将覆盖当前定义的所有通道。MAC 层参数（Join-Accept 消息传输的 RXdelay1、RX2 数据速率和 RX1 DR 偏移量除外）都应（SHALL）重置为默认值。
- Rejoin-request 类型2，如果 CFlist 字段不存在，则设备应保持其当前通道定义不变。如果 CFlist 存在，它将覆盖当前定义的所有通道。所有其他 MAC 参数（被重置的帧计数器除外）保持不变。

在所有成功处理 Join-accept 消息之后，设备应（SHALL）发送 ***RekeyInd*** MAC 指令，直到接收到 ***RekeyConf*** 指令（见5.9）。网络服务器以收到 ***RekeyInd*** 上行指令作为切换到新的安全上下文的信号。

#### 6.2.4 ReJoin-request message

##### 6.2.4.1 ReJoin-request Type 0 or 2 message

##### 6.2.4.2 ReJoin-request Type 1 message

##### 6.2.4.3 Rejoin-Request transmissions

##### 6.2.4.4 Rejoin-Request message processing

##### 6.2.5 Key derivation diagram

下面的图表总结了设备连接到 LoRaWAN1.0 或 1.1 网络服务器的情况下的秘钥派生方案。

**LoRaWAN1.0 network backend:**

当一个 LoRaWAN1.1 设备分配给了LoRaWAN1.0.X 的网络后端，所有密钥都从 NwkKey 根密钥派生。设备的AppKey 不被使用。

![](/media/15663905802044.jpg)

**LoRaWAN1.1 network backend:**

![](/media/15663906210502.jpg)


----



- <a name="6.2.2">6.2.2 应用密钥(AppKey)</a>  

AppKey 是由应用程序拥有者分配给终端，很可能是由应用程序指定的根密钥来衍生的，并且受提供者控制。当终端通过空中激活方式加入网络，AppKey用来产生会话密钥NwkSKey和AppSKey，会话密钥分别用来加密和校验网络层和应用层数据。

- <a name="6.2.3">6.2.3 加网流程</a>

从终端角度看，加网流程是由和服务器的两个MAC命令交互组成的，分别是 join request 和 join accept。

- <a name="6.2.4">6.2.4 Join-request 消息</a>

加网流程总是由终端发送 join-request 来发起。



join-request 消息包含了AppEUI 和 DevEUI ，后面还跟了2个字节的声明 DevNonce。

DevNonce 是一个随机值。网络服务器为每个终端记录过去的 DevNonce 数值，如果相同设备发出相同的 DevNonce 的join request就会忽略。

join-request 消息的MIC数值(见第4章 MAC帧格式)按照如下公式计算：

> cmac = aes128_cmac(AppKey, MHDR | AppEUI | DevEUI | DevNonce)
> MIC = cmac[0..3]

join-request 消息不用加密。


- <a name="6.2.5">6.2.5 Join-accept 消息</a>

如果网络服务器准许终端加入网络，就会用 **join-accept** 对 **join-request** 进行应答。**join-accept** 是作为一个普通下行帧进行下发的，唯一的区别是它使用的是 JOIN_ACCEPT_DELAY1 或者 JOIN_ACCEPT_DELAY2 (分别代替 RECEIVE_DELAY1 和 RECEIVE_DELAY2 )但是它所使用的两个接收窗口的信道频率和数据率和 LoRaWAN 地区参数文件[PARAMS]"接收窗口"部分所描述的 RX1 和 RX2 接收窗口相同。

如果 **join-request** 不被接受，则终端不会收到回应。

**join-accept** 消息的帧格式包括3字节的应用随机数(**AppNonce**)，网络标识符(**NetID**)，终端地址(**DevAddr**)，TX和RX之间的延时(**RxDelay**)，用于终端所加入的网络的可选信道频率列表(**CFList**)。**CFList** 的选择是由区域指定的，在 LoRaWAN 地区参数文件[PARAMS]中进行定义。

<table>
   <tr>
      <td><b>Size (bytes)</b></td>
      <td>3</td>
      <td>3</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>(16)Optional</td>
   </tr>
   <tr>
      <td><b>Join Accpet</b></td>
      <td>AppNonce</td>
      <td>NetID</td>
      <td>DevAddr</td>
      <td>DLSettings</td>
      <td>RXDelay</td>
      <td>CFList</td>
   </tr>
</table>

**AppNonce**是由网络服务器所提供的一个随机值或者某些形式的唯一ID，用于终端得到两个会话密钥**NwkSKey**和**AppSKey**，如下:

    NwkSKey = aes128_encrypt(AppKey, 0x01 | AppNonce | NetID | DevNonce | pad 16 )
    AppSKey = aes128_encrypt(AppKey, 0x02 | AppNonce | NetID | DevNonce | pad 16 )

**join-accept**的 MIC 值由如下计算得到:

    cmac = aes128_cmac(AppKey,MHDR | AppNonce | NetID | DevAddr | DLSettings | RxDelay | CFList) 
    MIC = cmac[0..3]

**join-accept**消息是使用**AppKey**进行加密的，如下:

    aes128_decrypt(AppKey, AppNonce | NetID | DevAddr | DLSettings | RxDelay | CFList | MIC) 

> 注意:网络服务器在 ECB 模式下使用一个 AES 解密操作去对 **join-accept** 消息进行加密，因此终端就可以使用一个 AES 加密操作去对消息进行解密。这样终端只需要去实现 AES 加密而不是 AES 解密。

> 注意:建立这两个会话密钥使得 网络服务器 中的网络运营商无法窃听应用层数据。在这样的设置中，应用提供商必须支持网络运营商处理终端的加网以及为终端生成 NwkSkey。同时应用提供商向网络运营商承诺，它将承担终端所产生的任何流量费用并且保持用于保护应用数据的AppSKey的完全控制权。

**NetID**的格式如下所述:**NetID**的7个最低有效位称为**NwkID**并且和之前所描述的终端的短地址的7个最高有效位相对应。保留的17个最高有效位可以由网络运营商进行自由选择。

**DLsettings**字段包含了下行配置:

<table>
   <tr>
      <td><b>Bits</b></td>
      <td>7</td>
      <td>6:4</td>
      <td>3:0</td>
   </tr>
   <tr>
      <td><b>DLsettings</b></td>
      <td>RFU</td>
      <td>RX1DRoffset</td>
      <td>RX2 Data rate</td>
   </tr>
</table>

**RX1DRoffset**位域设置上行数据速率和RX1下行数据速率的偏移量。默认情况下偏移量为0（意思就是上行数据速率与下行数据速率相等)。偏移量用于考虑一些地区的基站最大功率密度限制和平衡上下行射频链路预算。

上行和下行的数据率之间的实际关系是由区域指定的，在LoRaWAN地区参数文件[PARAM]中进行定义。

延时**RxDelay**和**RXTimingSetupReq**里的**Delay**字段有着相同的约定。


[^注1]: [RFC4493]
[^注2]: The pad<sub>16</sub> function appends zero octets so that the length of the data is a multiple of 16 
[^注3]: [RFC4493]
[^注4]: [RFC4493]

